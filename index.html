<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jadwal Pelajaran - IDN Boarding School Pamijahan</title>
    <meta
      name="description"
      content="Aplikasi jadwal pelajaran digital untuk IDN Boarding School Pamijahan. Lihat jadwal harian, jadwal guru, dan informasi piket secara real-time. Dikelola secara terpusat oleh admin." />
    <meta name="theme-color" content="#0f172a" />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/jadwal-pelajaran/assets/apple-icon-57x57.png" />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/jadwal-pelajaran/assets/apple-icon-60x60.png" />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/jadwal-pelajaran/assets/apple-icon-72x72.png" />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/jadwal-pelajaran/assets/apple-icon-76x76.png" />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/jadwal-pelajaran/assets/apple-icon-114x114.png" />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/jadwal-pelajaran/assets/apple-icon-120x120.png" />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/jadwal-pelajaran/assets/apple-icon-144x144.png" />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/jadwal-pelajaran/assets/apple-icon-152x152.png" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/jadwal-pelajaran/assets/apple-icon-180x180.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/jadwal-pelajaran/assets/android-icon-192x192.png" />

    <link
      rel="icon"
      type="image/png"
      sizes="144x144"
      href="/jadwal-pelajaran/assets/android-icon-144x144.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/jadwal-pelajaran/assets/favicon-32x32.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/jadwal-pelajaran/assets/favicon-96x96.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/jadwal-pelajaran/assets/favicon-16x16.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet" />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .tab-button.active {
        border-color: #4f46e5;
        color: #4f46e5;
        background-color: #eef2ff;
      }
      .day-button.selected {
        background-color: #4f46e5 !important;
        color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      .day-button.today {
        font-weight: 700;
        border-color: #6366f1;
        color: #4f46e5;
      }
      .toast {
        visibility: hidden;
        min-width: 250px;
        margin-left: -125px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 16px;
        position: fixed;
        z-index: 100;
        left: 50%;
        bottom: 30px;
        opacity: 0;
        transition: opacity 0.5s, visibility 0.5s;
      }
      .toast.show {
        visibility: visible;
        opacity: 1;
      }
      /* Style for schedule grid */
      .schedule-grid th,
      .schedule-grid td {
        border: 1px solid #e5e7eb;
        padding: 0.75rem;
        text-align: center;
        min-width: 120px;
        transition: background-color 0.3s;
      }
      .schedule-grid th {
        background-color: #f9fafb;
      }
      /* --- ATURAN BARU FINAL UNTUK ISTIRAHAT --- */
      .schedule-break-row td,
      td.schedule-break-row {
        background-color: #f0fdf4; /* green-50 */
        color: #15803d; /* green-700 */
        font-weight: 600;
        text-align: center;
      }

      /* @media print {
        #print-output .schedule-grid .schedule-break-row,
        #print-output .schedule-grid tr.schedule-break-row > td {
          background-color: #f0fdf4 !important;
          color: #15803d !important;
        }
      } */
      /* Style for highlighting current time */
      .current-timeslot {
        background-color: #fef9c3 !important; /* yellow-100 */
      }
      .current-timeslot-header {
        background-color: #fef9c3 !important;
        border-left: 4px solid #f59e0b;
      }

      /* Modal Styles */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .modal-content {
        background-color: white;
        padding: 1.5rem;
        border-radius: 0.75rem;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
      }

      /* Responsive tabs */
      .tab-container {
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
      }

      .tab-container::-webkit-scrollbar {
        height: 4px;
      }

      .tab-container::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      .tab-container::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }

      .tab-container::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      .tab-button {
        flex-shrink: 0;
      }

      /* Print Styles */
      #print-output {
        display: none;
      }
      @page {
        size: A4 landscape;
        margin: 1cm;
      }
      @media print {
        body {
          background-color: white;
          -webkit-print-color-adjust: exact;
          color-adjust: exact;
        }
        #app > header,
        #app > main > aside,
        #guest-view,
        .no-print,
        #admin-view {
          display: none !important;
        }
        #print-output {
          display: block !important;
        }
        #app {
          max-width: 100%;
          padding: 0;
          margin: 0;
        }

        /* Header cetak */
        #print-output .print-header {
          text-align: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 3px solid #333;
        }
        #print-output h2 {
          font-size: 20px;
          margin-bottom: 5px;
          text-align: center;
          font-weight: bold;
          text-transform: uppercase;
        }
        #print-output h3 {
          font-size: 14px;
          margin-top: 5px;
          font-weight: 600;
        }
        #print-output .print-date {
          font-size: 11px;
          color: #666;
          margin-top: 8px;
        }

        /* Table styling */
        #print-output .schedule-grid {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
        }
        #print-output .schedule-grid th,
        #print-output .schedule-grid td {
          font-size: 10px;
          padding: 8px 6px;
          border: 1px solid #333;
          text-align: center;
          vertical-align: middle;
        }
        #print-output .schedule-grid th {
          background-color: #e5e7eb !important;
          font-weight: bold;
          text-transform: uppercase;
          font-size: 9px;
        }
        #print-output .schedule-grid td.font-semibold {
          background-color: #f3f4f6 !important;
          font-weight: 600;
        }
        #print-output .schedule-grid .schedule-break-row {
          background-color: #f0fdf4 !important;
          color: #15803d;
          font-weight: 600;
        }

        /* Keterangan guru */
        .keterangan-guru {
          margin-top: 20px;
          page-break-inside: avoid;
          font-size: 10px;
          border-top: 2px solid #ddd;
          padding-top: 15px;
        }
        .keterangan-guru h3 {
          font-size: 12px;
          font-weight: bold;
          margin-bottom: 10px;
        }
        .keterangan-guru ul {
          list-style-type: none;
          padding-left: 0;
          columns: 2;
          -webkit-columns: 2;
          -moz-columns: 2;
          column-gap: 30px;
        }
        .keterangan-guru li {
          margin-bottom: 6px;
          break-inside: avoid;
        }

        /* Summary box */
        #print-output .stats-summary {
          margin: 15px 0;
          padding: 12px;
          background-color: #f9fafb !important;
          border: 2px solid #cbd5e1;
          font-size: 11px;
          line-height: 1.6;
        }
      }
    </style>
  </head>
  <body class="bg-slate-100">
    <div id="app" class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
      <header class="flex justify-between items-center mb-6 flex-wrap gap-4">
        <div>
          <h1
            class="text-2xl sm:text-3xl font-bold text-slate-800 flex items-center gap-3">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-8 w-8 text-indigo-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span>Jadwal Pelajaran IDN Pamijahan</span>
          </h1>
          <p class="text-slate-500 mt-1 ml-11">
            Sistem Manajemen Jadwal Terintegrasi
          </p>
        </div>
        <div class="flex items-center space-x-4">
          <div
            id="realtime-clock"
            class="text-xl font-bold text-indigo-600 bg-indigo-100 px-4 py-2 rounded-lg flex items-center gap-2">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="clock-time"></span>
          </div>
          <button
            id="auth-button"
            class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 flex items-center space-x-2">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor">
              <path
                fill-rule="evenodd"
                d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                clip-rule="evenodd" />
            </svg>
            <span id="auth-button-text">Login Admin</span>
          </button>
        </div>
      </header>

      <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Kolom Kiri: Kalender & Filter -->
        <aside class="lg:col-span-1 space-y-6 no-print">
          <div class="bg-white p-4 rounded-xl shadow-lg">
            <h3 class="font-bold text-slate-700 mb-3">Pilih Hari</h3>
            <div id="calendar-container" class="grid grid-cols-1 gap-2"></div>
          </div>

          <div
            id="piket-container"
            class="bg-white p-4 rounded-xl shadow-lg space-y-4">
            <h3 class="font-bold text-slate-700 flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-indigo-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
              <span>Guru Piket Hari Ini</span>
            </h3>
            <div id="piket-content" class="space-y-3"></div>
          </div>

          <div class="bg-white p-4 rounded-xl shadow-lg">
            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-indigo-600"
                viewBox="0 0 20 20"
                fill="currentColor">
                <path
                  d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.993.883L4 8v10a1 1 0 001 1h10a1 1 0 001-1V8a1 1 0 00-1-1h-1V6a4 4 0 00-4-4zm0 2a2 2 0 012 2v1H8V6a2 2 0 012-2z" />
              </svg>
              <span>Lihat Jadwal Kelas</span>
            </h3>
            <p class="text-xs text-slate-500 mb-2">
              Pilih kelas untuk melihat jadwal mingguan lengkapnya.
            </p>
            <input
              id="filter-kelas-input"
              list="filter-kelas-datalist"
              class="w-full p-2 border rounded-md bg-slate-50"
              placeholder="Cari & pilih kelas..." />
            <datalist id="filter-kelas-datalist"></datalist>
          </div>

          <div class="bg-white p-4 rounded-xl shadow-lg">
            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-indigo-600"
                viewBox="0 0 20 20"
                fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                  clip-rule="evenodd" />
              </svg>
              <span>Lihat Jadwal Guru</span>
            </h3>
            <p class="text-xs text-slate-500 mb-2">
              Pilih nama guru untuk melihat jadwal mingguan lengkapnya.
            </p>
            <input
              id="filter-guru-input"
              list="filter-guru-datalist"
              class="w-full p-2 border rounded-md bg-slate-50"
              placeholder="Cari & pilih guru..." />
            <datalist id="filter-guru-datalist"></datalist>
          </div>

          <div
            id="info-container"
            class="bg-white p-4 rounded-xl shadow-lg space-y-4">
            <h3 class="font-bold text-slate-700 flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-indigo-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Informasi Penting</span>
            </h3>
            <div id="info-content" class="space-y-3"></div>
          </div>
        </aside>

        <!-- Kolom Kanan: Tampilan Jadwal & Admin Panel -->
        <div class="lg:col-span-3">
          <!-- Guest View -->
          <div
            id="guest-view"
            class="bg-white p-6 rounded-xl shadow-lg min-h-[500px]">
            <!-- Tampilan Jadwal Harian -->
            <div id="daily-schedule-view">
              <div class="flex justify-between items-center mb-4">
                <h2
                  id="schedule-title"
                  class="text-xl font-bold text-slate-800">
                  Jadwal Harian
                </h2>
                <button
                  id="print-button-daily"
                  class="no-print bg-slate-200 text-slate-700 font-semibold py-2 px-3 rounded-lg hover:bg-slate-300 transition-colors duration-200 flex items-center space-x-2 text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  <span>Cetak</span>
                </button>
              </div>
              <div
                id="schedule-content"
                class="text-slate-600 overflow-x-auto"></div>
            </div>
            <!-- Tampilan Jadwal Guru -->
            <div id="teacher-schedule-view" class="hidden">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h2
                    id="teacher-schedule-title"
                    class="text-xl font-bold text-slate-800">
                    Jadwal Mengajar Guru
                  </h2>
                  <p id="teacher-total-jp" class="text-sm text-slate-500"></p>
                </div>
                <button
                  id="print-button-teacher"
                  class="no-print bg-slate-200 text-slate-700 font-semibold py-2 px-3 rounded-lg hover:bg-slate-300 transition-colors duration-200 flex items-center space-x-2 text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  <span>Cetak</span>
                </button>
              </div>
              <div
                id="teacher-schedule-content"
                class="text-slate-600 overflow-x-auto"></div>
            </div>
            <div id="class-schedule-view" class="hidden">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h2
                    id="class-schedule-title"
                    class="text-xl font-bold text-slate-800">
                    Jadwal Pelajaran Kelas
                  </h2>
                </div>
                <button
                  id="print-button-class"
                  class="no-print bg-slate-200 text-slate-700 font-semibold py-2 px-3 rounded-lg hover:bg-slate-300 transition-colors duration-200 flex items-center space-x-2 text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  <span>Cetak</span>
                </button>
              </div>
              <div
                id="class-schedule-content"
                class="text-slate-600 overflow-x-auto"></div>
            </div>
          </div>

          <!-- Admin View -->
          <div
            id="admin-view"
            class="bg-white p-4 sm:p-6 rounded-xl shadow-lg hidden">
            <div class="border-b border-gray-200 mb-4">
              <nav
                class="-mb-px flex space-x-6 tab-container"
                aria-label="Tabs">
                <button
                  id="tab-jadwal"
                  class="tab-button active flex items-center space-x-2 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span>Kelola Jadwal</span>
                </button>
                <button
                  id="tab-master"
                  class="tab-button flex items-center space-x-2 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7s0 0 0 0" />
                  </svg>
                  <span>Data Master</span>
                </button>
                <button
                  id="tab-tugas"
                  class="tab-button flex items-center space-x-2 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor">
                    <path
                      fill-rule="evenodd"
                      d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"
                      clip-rule="evenodd" />
                    <path
                      d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z" />
                  </svg>
                  <span>Tugas Tambahan</span>
                </button>
                <button
                  id="tab-statistik"
                  class="tab-button flex items-center space-x-2 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                  <span>Statistik</span>
                </button>
                <button
                  id="tab-ai-tools"
                  class="tab-button flex items-center space-x-2 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                  </svg>
                  <span>Alat AI</span>
                </button>
                <button
                  id="tab-export"
                  class="tab-button flex items-center space-x-2 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  <span>Ekspor Data</span>
                </button>
                <button
                  id="tab-info"
                  class="tab-button flex items-center space-x-2 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>Informasi</span>
                </button>
              </nav>
            </div>

            <!-- Admin Content: Jadwal -->
            <div id="admin-content-jadwal">
              <div
                class="bg-slate-50 border border-slate-200 rounded-xl p-4 sm:p-6 mb-6">
                <h3 class="text-lg font-bold mb-4 text-slate-800">
                  Tambah/Edit Jadwal
                </h3>
                <form
                  id="schedule-form"
                  class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                  <input type="hidden" id="schedule-id" />
                  <div>
                    <label class="text-sm font-medium text-slate-700"
                      >Hari</label
                    >
                    <select
                      id="schedule-day"
                      class="mt-1 p-2 border rounded-md w-full bg-white"
                      required>
                      <option value="">Pilih Hari</option>
                    </select>
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <div>
                      <label class="text-sm font-medium text-slate-700"
                        >Dari JP</label
                      >
                      <select
                        id="schedule-jp-start"
                        class="mt-1 p-2 border rounded-md w-full bg-white"
                        required>
                        <option value="">Pilih JP</option>
                      </select>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-slate-700"
                        >Sampai JP</label
                      >
                      <select
                        id="schedule-jp-end"
                        class="mt-1 p-2 border rounded-md w-full bg-white">
                        <option value="">Sama</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-slate-700"
                      >Mata Pelajaran</label
                    >
                    <input
                      id="schedule-mapel-input"
                      list="mapel-list-datalist"
                      class="mt-1 p-2 border rounded-md w-full bg-white"
                      placeholder="Cari mapel..."
                      required />
                    <datalist id="mapel-list-datalist"></datalist>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-slate-700"
                      >Guru</label
                    >
                    <input
                      id="schedule-guru-input"
                      list="guru-list-datalist"
                      class="mt-1 p-2 border rounded-md w-full bg-white"
                      placeholder="Cari guru..." />
                    <datalist id="guru-list-datalist"></datalist>
                  </div>
                  <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-2"
                      >Pilih Kelas
                      <span
                        id="class-limit-label"
                        class="text-xs text-slate-500"
                        >(Maksimal 3 kelas)</span
                      ></label
                    >
                    <div
                      id="schedule-kelas-checkboxes"
                      class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-32 overflow-y-auto bg-white p-2 border rounded-md"></div>
                  </div>
                  <div class="sm:col-span-2 flex items-center space-x-3 mt-2">
                    <button
                      type="submit"
                      class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 font-semibold flex items-center space-x-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor">
                        <path
                          fill-rule="evenodd"
                          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                          clip-rule="evenodd" />
                      </svg>
                      <span>Simpan Jadwal</span>
                    </button>
                    <button
                      type="button"
                      id="clear-form-btn"
                      class="bg-slate-200 text-slate-700 py-2 px-4 rounded-lg hover:bg-slate-300 font-semibold">
                      Batal
                    </button>
                  </div>
                </form>
              </div>

              <div>
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-bold text-slate-800">
                    Daftar Jadwal
                  </h3>
                  <div class="w-1/2">
                    <input
                      type="text"
                      id="admin-search-input"
                      placeholder="Cari berdasarkan guru atau mapel..."
                      class="w-full p-2 border rounded-md bg-white text-sm" />
                  </div>
                </div>
                <div class="max-h-[500px] overflow-y-auto border rounded-lg">
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-slate-100 sticky top-0 z-10">
                        <tr>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">
                            Hari
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">
                            JP
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">
                            Kelas
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">
                            Mapel
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">
                            Guru
                          </th>
                          <th
                            class="px-4 py-3 text-center text-xs font-bold text-slate-600 uppercase">
                            Aksi
                          </th>
                        </tr>
                      </thead>
                      <tbody
                        id="schedule-list"
                        class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Admin Content: Master Data -->
            <div id="admin-content-master" class="hidden space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div id="kelas-management-section"></div>
                <div id="guru-management-section"></div>
                <div id="mapel-management-section"></div>
              </div>
              <div class="grid grid-cols-1 gap-6">
                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                  <h4
                    class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                    🔗 <span>Pengaturan API Piket</span>
                  </h4>
                  <form id="piket-api-form" class="flex gap-2 mb-3">
                    <input
                      type="url"
                      id="piket-api-url"
                      placeholder="https://url-api-piket.com/data"
                      class="flex-grow p-2 border rounded-md bg-white text-sm"
                      required /><button
                      type="submit"
                      class="bg-indigo-600 text-white px-4 rounded-md hover:bg-indigo-700 font-semibold">
                      Simpan
                    </button>
                  </form>
                </div>
                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                  <h4
                    class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                    ⚙️ <span>Pengaturan Perhitungan JP</span>
                  </h4>
                  <p class="text-xs text-slate-500 mb-2">
                    Pilih bagaimana total Jam Pelajaran (JP) untuk guru dihitung
                    saat mengajar kelas gabungan.
                  </p>
                  <div id="jp-calculation-settings" class="space-y-2 mt-2">
                    <div class="flex items-center">
                      <input
                        id="jp-by-class"
                        name="jp-calculation"
                        type="radio"
                        value="byClass"
                        class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" />
                      <label
                        for="jp-by-class"
                        class="ml-3 block text-sm font-medium text-gray-700">
                        Hitung berdasarkan Jumlah Kelas
                        <span class="text-xs text-slate-500"
                          >(Contoh: 1 sesi di 3 kelas = 3 JP)</span
                        >
                      </label>
                    </div>
                    <div class="flex items-center">
                      <input
                        id="jp-by-session"
                        name="jp-calculation"
                        type="radio"
                        value="bySession"
                        class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" />
                      <label
                        for="jp-by-session"
                        class="ml-3 block text-sm font-medium text-gray-700">
                        Hitung berdasarkan Sesi Mengajar
                        <span class="text-xs text-slate-500"
                          >(Contoh: 1 sesi di 3 kelas = 1 JP)</span
                        >
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Admin Content: Statistik -->
            <div id="admin-content-statistik" class="hidden">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">
                  Beban Mengajar Guru (per Minggu)
                </h3>
                <button
                  id="print-stats-button"
                  class="no-print bg-slate-200 text-slate-700 font-semibold py-2 px-3 rounded-lg hover:bg-slate-300 transition-colors duration-200 flex items-center space-x-2 text-sm">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  <span>Cetak Statistik</span>
                </button>
              </div>
              <div
                id="teacher-stats-container"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- Admin Content: AI Tools -->
            <div id="admin-content-ai-tools" class="hidden space-y-6">
              <div>
                <h3 class="text-lg font-bold text-slate-800">
                  Pemeriksa Konflik Jadwal
                </h3>
                <p class="text-sm text-slate-500 mt-1 mb-3">
                  Jalankan pemeriksaan manual di seluruh data jadwal untuk
                  menemukan potensi konflik seperti guru atau kelas yang
                  dijadwalkan ganda pada waktu yang sama.
                </p>
                <button
                  id="check-conflicts-btn"
                  class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 flex items-center space-x-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <span>Mulai Pemeriksaan</span>
                </button>
              </div>
              <div class="border-t pt-6">
                <h3 class="text-lg font-bold text-slate-800">
                  Pemeriksa Jadwal Guru Bersamaan
                </h3>
                <p class="text-sm text-slate-500 mt-1 mb-3">
                  Pilih dua guru untuk melihat di hari dan JP apa saja mereka
                  sama-sama memiliki jadwal mengajar.
                </p>
                <div class="flex items-center gap-4">
                  <input
                    id="compare-teacher-a-input"
                    list="compare-teacher-a-datalist"
                    class="w-full p-2 border rounded-md bg-white"
                    placeholder="Cari Guru A..." />
                  <datalist id="compare-teacher-a-datalist"></datalist>
                  <input
                    id="compare-teacher-b-input"
                    list="compare-teacher-b-datalist"
                    class="w-full p-2 border rounded-md bg-white"
                    placeholder="Cari Guru B..." />
                  <datalist id="compare-teacher-b-datalist"></datalist>
                  <button
                    id="compare-teachers-btn"
                    class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700">
                    Cek
                  </button>
                </div>
              </div>

              <div class="border-t pt-6">
                <h3 class="text-lg font-bold text-slate-800">
                  Saran Jadwal (Gemini AI)
                </h3>
                <p class="text-sm text-slate-500 mt-1 mb-3">
                  Gunakan kekuatan AI untuk menganalisis jadwal dan memberikan
                  rekomendasi untuk penyeimbangan beban mengajar guru.
                </p>
                <button
                  id="ai-suggestion-btn"
                  class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md flex items-center space-x-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                  </svg>
                  <span>Dapatkan Saran Jadwal</span>
                </button>
              </div>
              <div id="conflict-results-container" class="hidden">
                <h4 class="font-semibold text-slate-700">
                  Hasil Pemeriksaan & Saran AI:
                </h4>
                <div
                  id="conflict-results"
                  class="bg-slate-100 text-sm p-4 rounded-md mt-2 max-h-60 overflow-y-auto whitespace-pre-wrap"></div>
              </div>
            </div>

            <div id="admin-content-export" class="hidden space-y-6">
              <div>
                <h3 class="text-lg font-bold text-slate-800">
                  Ekspor Data Jadwal
                </h3>
                <p class="text-sm text-slate-500 mt-1 mb-3">
                  Unduh seluruh data jadwal pelajaran dalam format JSON (untuk
                  backup atau migrasi) atau CSV (untuk dibuka di spreadsheet).
                </p>
                <div class="flex items-center space-x-4">
                  <button
                    id="export-json-btn"
                    class="bg-amber-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-amber-600 transition-colors duration-200 flex items-center space-x-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span>Ekspor ke JSON</span>
                  </button>
                  <button
                    id="export-csv-btn"
                    class="bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition-colors duration-200 flex items-center space-x-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span>Ekspor ke CSV</span>
                  </button>
                </div>
              </div>
            </div>

            <div id="admin-content-info" class="hidden space-y-6">
              <div
                class="bg-slate-50 border border-slate-200 rounded-xl p-4 sm:p-6">
                <h3 class="text-lg font-bold mb-4 text-slate-800">
                  Tambah/Edit Informasi
                </h3>
                <form id="info-form" class="space-y-4">
                  <input type="hidden" id="info-id" />
                  <div>
                    <label
                      for="info-title"
                      class="text-sm font-medium text-slate-700"
                      >Judul</label
                    >
                    <input
                      type="text"
                      id="info-title"
                      class="mt-1 p-2 border rounded-md w-full bg-white"
                      required />
                  </div>
                  <div>
                    <label
                      for="info-url"
                      class="text-sm font-medium text-slate-700"
                      >URL Tautan</label
                    >
                    <input
                      type="url"
                      id="info-url"
                      class="mt-1 p-2 border rounded-md w-full bg-white"
                      required />
                  </div>
                  <div>
                    <label
                      for="info-description"
                      class="text-sm font-medium text-slate-700"
                      >Deskripsi (Opsional)</label
                    >
                    <textarea
                      id="info-description"
                      rows="2"
                      class="mt-1 p-2 border rounded-md w-full bg-white"></textarea>
                  </div>
                  <div class="flex items-center space-x-3">
                    <button
                      type="submit"
                      class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 font-semibold flex items-center space-x-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor">
                        <path
                          fill-rule="evenodd"
                          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                          clip-rule="evenodd" />
                      </svg>
                      <span>Simpan Informasi</span>
                    </button>
                    <button
                      type="button"
                      id="clear-info-form-btn"
                      class="bg-slate-200 text-slate-700 py-2 px-4 rounded-lg hover:bg-slate-300 font-semibold">
                      Batal
                    </button>
                  </div>
                </form>
              </div>
              <div>
                <h3 class="text-lg font-bold mb-4 text-slate-800">
                  Daftar Informasi
                </h3>
                <div id="info-list" class="space-y-3"></div>
              </div>
            </div>

            <!-- Admin Content: Tugas Tambahan -->
            <div id="admin-content-tugas" class="hidden space-y-6">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                  <h4
                    class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5 text-indigo-600"
                      viewBox="0 0 20 20"
                      fill="currentColor">
                      <path
                        fill-rule="evenodd"
                        d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"
                        clip-rule="evenodd" />
                      <path
                        d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z" />
                    </svg>
                    <span>Manajemen Jabatan</span>
                  </h4>
                  <form id="tugas-form" class="grid grid-cols-3 gap-2 mb-3">
                    <input type="hidden" id="tugas-id" />
                    <input
                      type="text"
                      id="tugas-name"
                      placeholder="Nama Jabatan"
                      class="col-span-2 p-2 border rounded-md bg-white text-sm"
                      required />
                    <input
                      type="number"
                      id="tugas-jp"
                      placeholder="JP"
                      min="1"
                      class="p-2 border rounded-md bg-white text-sm"
                      required />
                    <button
                      type="submit"
                      class="col-span-2 bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 font-semibold">
                      Tambah Jabatan
                    </button>
                    <button
                      type="button"
                      id="clear-tugas-btn"
                      class="bg-slate-300 text-slate-700 py-2 rounded-md hover:bg-slate-400 font-semibold">
                      Batal
                    </button>
                  </form>
                  <input
                    type="text"
                    id="tugas-search"
                    placeholder="Cari jabatan..."
                    class="w-full p-2 border rounded-md bg-white text-sm mb-3" />
                  <div class="max-h-60 overflow-y-auto">
                    <ul id="tugas-list" class="space-y-2"></ul>
                  </div>
                </div>
                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                  <h4
                    class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5 text-indigo-600"
                      viewBox="0 0 20 20"
                      fill="currentColor">
                      <path
                        d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                    </svg>
                    <span>Penugasan Guru</span>
                  </h4>
                  <input
                    type="text"
                    id="teacher-search"
                    placeholder="Cari guru..."
                    class="w-full p-2 border rounded-md bg-white text-sm mb-3" />
                  <div
                    id="teacher-assignment-list"
                    class="max-h-80 overflow-y-auto space-y-2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div id="assignment-modal" class="modal-backdrop hidden">
      <div class="modal-content">
        <h3 id="assignment-modal-title" class="text-lg font-bold mb-4"></h3>
        <div id="assignment-modal-body" class="space-y-2"></div>
        <div class="mt-4 flex justify-end space-x-2">
          <button
            id="assignment-modal-close"
            class="bg-slate-200 text-slate-700 py-2 px-4 rounded-lg hover:bg-slate-300 font-semibold">
            Tutup
          </button>
          <button
            id="assignment-modal-save"
            class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 font-semibold">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <div id="print-output"></div>
    <div id="toast" class="toast"></div>

    <script type="module">
      const firebaseConfig = {
        apiKey: "AIzaSyCtMvL8jM87kvtmZafYhSju39xMFm9M_ZM",
        authDomain: "jadwal-pelajaran-idn.firebaseapp.com",
        projectId: "jadwal-pelajaran-idn",
        storageBucket: "jadwal-pelajaran-idn.appspot.com",
        messagingSenderId: "1037878545915",
        appId: "1:1037878545915:web:528924f8967d2fa886cf5e",
      };

      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        onSnapshot,
        addDoc,
        doc,
        deleteDoc,
        setDoc,
        getDoc,
        writeBatch,
        query,
        where,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const provider = new GoogleAuthProvider();

      let allSchedules = [];
      let allClasses = [];
      let allTeachers = [];
      let allMapel = [];
      let allTugas = [];
      let currentTeacherForAssignment = null;

      const appId = "default-app-id";

      const daysOfWeek = [
        "Minggu",
        "Senin",
        "Selasa",
        "Rabu",
        "Kamis",
        "Jumat",
        "Sabtu",
      ];
      const daysOfWeekApi = [
        "minggu",
        "senin",
        "selasa",
        "rabu",
        "kamis",
        "jumat",
        "sabtu",
      ];

      const timeSlots = [
        { type: "lesson", jp: 1, time: "07:30-08:10" },
        { type: "lesson", jp: 2, time: "08:10-08:55" },
        { type: "lesson", jp: 3, time: "08:55-09:30" },
        { type: "lesson", jp: 4, time: "09:30-09:50" },
        { type: "lesson", jp: 5, time: "09:50-10:30" },
        { type: "lesson", jp: 6, time: "10:30-11:10" },
        {
          type: "break",
          name: "Istirahat & Sholat Dzuhur",
          time: "11:10-13:00",
        },
        { type: "lesson", jp: 7, time: "13:00-13:45" },
        { type: "lesson", jp: 8, time: "13:45-14:30" },
        { type: "lesson", jp: 9, time: "14:30-15:00" },
      ];

      let selectedDayIndex;
      let jpCalculationMethod = "byClass"; // Default value

     

      

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      async function isAdmin(userId) {
        if (!userId) return false;
        const adminDocRef = doc(
          db,
          `artifacts/${appId}/public/data/admins`,
          userId
        );
        const adminDoc = await getDoc(adminDocRef);
        return adminDoc.exists();
      }

      function renderCalendar() {
        const calendarContainer = document.getElementById("calendar-container");
        calendarContainer.innerHTML = "";

        const todayIndex = new Date().getDay();

        for (let i = 1; i <= 5; i++) {
          const dayButton = document.createElement("button");
          dayButton.className =
            "day-button p-3 border rounded-lg text-left transition-all duration-200 ease-in-out shadow-sm hover:shadow-md";
          dayButton.innerHTML = `<span class="font-semibold text-lg">${daysOfWeek[i]}</span>`;

          if (i === todayIndex) dayButton.classList.add("today");
          if (i === selectedDayIndex) dayButton.classList.add("selected");

          dayButton.onclick = () => {
            selectedDayIndex = i;
            document.getElementById("filter-guru-input").value = "";
            displayDailyScheduleView();
          };
          calendarContainer.appendChild(dayButton);
        }
      }

      function customClassSort(a, b) {
        const aName = a.name;
        const bName = b.name;

        const extractParts = (name) => {
          const parts = name.split(" ");
          const grade = parseInt(parts[0]) || 0;
          const major = parts.length > 1 ? parts[1] : "";
          const sub = parts.length > 2 ? parts[2] : "";
          return { grade, major, sub, original: name };
        };

        const aParts = extractParts(aName);
        const bParts = extractParts(bName);

        if (aParts.grade !== bParts.grade) {
          return aParts.grade - bParts.grade;
        }

        const majorOrder = ["RPL", "TKJ", "DKV"];
        const aMajorIndex = majorOrder.indexOf(aParts.major);
        const bMajorIndex = majorOrder.indexOf(bParts.major);

        if (aMajorIndex !== -1 && bMajorIndex !== -1) {
          if (aMajorIndex !== bMajorIndex) {
            return aMajorIndex - bMajorIndex;
          }
        } else if (aMajorIndex !== -1) {
          return -1;
        } else if (bMajorIndex !== -1) {
          return 1;
        }

        if (aParts.sub && bParts.sub) {
          return aParts.sub.localeCompare(bParts.sub);
        }

        return aParts.original.localeCompare(bParts.original);
      }

      function customClassSortByName(a, b) {
        const extractParts = (name) => {
          const parts = name.split(" ");
          const grade = parseInt(parts[0]) || 0;
          const major = parts.length > 1 ? parts[1] : "";
          const sub = parts.length > 2 ? parts[2] : "";
          return { grade, major, sub, original: name };
        };
        const aParts = extractParts(a);
        const bParts = extractParts(b);

        if (aParts.grade !== bParts.grade) return aParts.grade - bParts.grade;

        const majorOrder = ["RPL", "TKJ", "DKV"];
        const aMajorIndex = majorOrder.indexOf(aParts.major);
        const bMajorIndex = majorOrder.indexOf(bParts.major);

        if (aMajorIndex !== -1 && bMajorIndex !== -1) {
          if (aMajorIndex !== bMajorIndex) return aMajorIndex - bMajorIndex;
        } else if (aMajorIndex !== -1) return -1;
        else if (bMajorIndex !== -1) return 1;

        if (aParts.sub && bParts.sub)
          return aParts.sub.localeCompare(bParts.sub);

        return aParts.original.localeCompare(bParts.original);
      }

      function generateScheduleTable(schedules, classes) {
        let tableHTML = `<table class="w-full schedule-grid"><thead><tr><th>Waktu</th>`;
        classes.forEach((c) => (tableHTML += `<th>${c.name}</th>`));
        tableHTML += "</tr></thead><tbody>";

        timeSlots.forEach((slot) => {
          if (slot.type === "break") {
            tableHTML += `<tr data-timeslot="${slot.time}"><td colspan="${
              classes.length + 1
            }" class="schedule-break-row">${slot.name} (${
              slot.time
            })</td></tr>`;
          } else {
            tableHTML += `<tr data-timeslot="${slot.time}"><td class="font-semibold bg-slate-50">JP ${slot.jp}<br><span class="text-xs font-normal">${slot.time}</span></td>`;

            let classIndex = 0;
            while (classIndex < classes.length) {
              const currentClass = classes[classIndex];
              const schedule = schedules.find(
                (s) => s.jp == slot.jp && s.classes.includes(currentClass.name)
              );

              if (schedule) {
                const isBreak = schedule.mapel
                  .toLowerCase()
                  .includes("istirahat");
                const cellClass = isBreak
                  ? "schedule-break-row"
                  : "hover:bg-indigo-50";
                const mapelClass = isBreak ? "" : "font-bold text-indigo-700";
                const infoClass = isBreak ? "" : "text-xs text-slate-600";

                const scheduledClassesInOrder = classes.filter((c) =>
                  schedule.classes.includes(c.name)
                );
                const firstClassInSchedule = scheduledClassesInOrder[0];

                if (currentClass.name === firstClassInSchedule.name) {
                  let span = 0;
                  let tempIndex = classIndex;
                  while (
                    tempIndex < classes.length &&
                    scheduledClassesInOrder.find(
                      (c) => c.name === classes[tempIndex].name
                    )
                  ) {
                    span++;
                    tempIndex++;
                  }
                  tableHTML += `<td class="${cellClass}" colspan="${span}"><div class="${mapelClass}">${
                    schedule.mapel
                  }</div><div class="${infoClass}">${
                    schedule.guru || ""
                  }</div></td>`;
                  classIndex += span;
                } else {
                  tableHTML += `<td>-</td>`;
                  classIndex++;
                }
              } else {
                tableHTML += `<td>-</td>`;
                classIndex++;
              }
            }
            tableHTML += "</tr>";
          }
        });
        return tableHTML + "</tbody></table>";
      }

      function displayDailyScheduleView() {
        document
          .getElementById("daily-schedule-view")
          .classList.remove("hidden");
        document
          .getElementById("teacher-schedule-view")
          .classList.add("hidden");
        document.getElementById("class-schedule-view").classList.add("hidden");
        renderCalendar();
        fetchAndDisplayPiket(selectedDayIndex);

        const dayIndex = selectedDayIndex;
        const scheduleTitle = document.getElementById("schedule-title");
        const scheduleContent = document.getElementById("schedule-content");

        scheduleTitle.textContent = `Jadwal Hari ${daysOfWeek[dayIndex]}`;

        if (allClasses.length === 0) {
          scheduleContent.innerHTML = `<p class="text-center text-slate-500 p-8">Belum ada data kelas.</p>`;
          return;
        }
        const schedulesForDay = allSchedules.filter((s) => s.day == dayIndex);
        scheduleContent.innerHTML = generateScheduleTable(
          schedulesForDay,
          allClasses
        );
      }

      function displayTeacherScheduleView(teacherName) {
        if (!teacherName) {
          displayDailyScheduleView();
          return;
        }
        document.getElementById("daily-schedule-view").classList.add("hidden");
        document
          .getElementById("teacher-schedule-view")
          .classList.remove("hidden");

        const teacherSchedules = allSchedules.filter(
          (s) => s.guru === teacherName
        );
        document.getElementById(
          "teacher-schedule-title"
        ).textContent = `Jadwal Mengajar: ${teacherName}`;

        const schedulableTeacherSchedules = teacherSchedules.filter(
          (s) => !s.mapel.toLowerCase().includes("istirahat")
        );
        let totalJP = 0;
        schedulableTeacherSchedules.forEach((s) => {
          if (jpCalculationMethod === "bySession") {
            totalJP += 1;
          } else {
            totalJP += s.classes.length;
          }
        });
        document.getElementById(
          "teacher-total-jp"
        ).textContent = `Total jam mengajar per minggu: ${totalJP} JP`;

        let tableHTML =
          '<table class="w-full schedule-grid"><thead><tr><th>Waktu</th>';
        for (let i = 1; i <= 5; i++) {
          tableHTML += `<th>${daysOfWeek[i]}</th>`;
        }
        tableHTML += "</tr></thead><tbody>";

        timeSlots.forEach((slot) => {
          if (slot.type === "break") {
            tableHTML += `<tr data-timeslot="${slot.time}"><td colspan="6" class="schedule-break-row">${slot.name} (${slot.time})</td></tr>`;
          } else {
            tableHTML += `<tr data-timeslot="${slot.time}"><td class="font-semibold bg-slate-50">JP ${slot.jp}<br><span class="text-xs font-normal">${slot.time}</span></td>`;
            for (let j = 1; j <= 5; j++) {
              // Day of week
              const schedule = allSchedules.find(
                (s) => s.jp == slot.jp && s.day == j && s.guru === teacherName
              );
              if (schedule) {
                const cellContent = `<div class="font-bold text-indigo-700">${
                  schedule.mapel
                }</div><div class="text-xs text-slate-600">${schedule.classes.join(
                  ", "
                )}</div>`;
                tableHTML += `<td class="hover:bg-indigo-50">${cellContent}</td>`;
              } else {
                tableHTML += `<td>-</td>`;
              }
            }
            tableHTML += "</tr>";
          }
        });
        tableHTML += "</tbody></table>";
        document.getElementById("teacher-schedule-content").innerHTML =
          tableHTML;
      }

      async function handleEditMasterData(collectionName, docId, oldName) {
        const newName = prompt(
          `Masukkan nama baru untuk "${oldName}":`,
          oldName
        );
        if (!newName || newName.trim() === "" || newName.trim() === oldName) {
          return;
        }

        const trimmedNewName = newName.trim();
        showToast(`Memperbarui "${oldName}" menjadi "${trimmedNewName}"...`);

        try {
          const batch = writeBatch(db);

          // 1. Update the master data document - PENTING: gunakan UPDATE bukan SET
          const masterDocRef = doc(
            db,
            `artifacts/${appId}/public/data/${collectionName}`,
            docId
          );

          // GUNAKAN UPDATE SUPAYA FIELD LAIN TIDAK HILANG
          batch.update(masterDocRef, { name: trimmedNewName });

          // 2. Find and update all related schedules
          const schedulesRef = collection(
            db,
            `artifacts/${appId}/public/data/schedules`
          );
          let q;
          if (collectionName === "kelas") {
            q = query(
              schedulesRef,
              where("classes", "array-contains", oldName)
            );
          } else {
            q = query(schedulesRef, where(collectionName, "==", oldName));
          }

          const snapshot = await getDocs(q);
          snapshot.forEach((scheduleDoc) => {
            if (collectionName === "kelas") {
              const currentClasses = scheduleDoc.data().classes;
              const updatedClasses = currentClasses.map((c) =>
                c === oldName ? trimmedNewName : c
              );
              batch.update(scheduleDoc.ref, { classes: updatedClasses });
            } else {
              batch.update(scheduleDoc.ref, {
                [collectionName]: trimmedNewName,
              });
            }
          });

          // 3. Commit the batch
          await batch.commit();
          showToast(`"${oldName}" berhasil diperbarui di seluruh jadwal!`);
        } catch (error) {
          console.error("Gagal memperbarui data:", error);
          showToast("Terjadi kesalahan saat memperbarui data.");
        }
      }

      function renderMasterDataTable(
        containerId,
        items,
        collectionName,
        searchTerm = ""
      ) {
        const container = document.getElementById(containerId);
        const lowerCaseSearchTerm = searchTerm.toLowerCase();

        const filteredItems = searchTerm
          ? items.filter((item) =>
              item.name.toLowerCase().includes(lowerCaseSearchTerm)
            )
          : items;

        if (filteredItems.length === 0) {
          container.innerHTML =
            '<p class="text-sm text-slate-500 p-4 text-center">Tidak ada data ditemukan.</p>';
          return;
        }

        const table = document.createElement("table");
        table.className = "min-w-full divide-y divide-gray-200";
        table.innerHTML = `
                <thead class="bg-slate-100 sticky top-0 z-10">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Nama</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-slate-600 uppercase">Aksi</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>
            `;

        const tbody = table.querySelector("tbody");
        filteredItems.forEach((item) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-50";
          tr.innerHTML = `
                    <td class="px-4 py-3 text-sm text-slate-700">${item.name}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center justify-center space-x-2">
                            <button class="edit-btn p-2 text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg>
                            </button>
                            <button class="delete-btn p-2 text-red-600 bg-red-100 rounded-md hover:bg-red-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </td>
                `;
          tr.querySelector(".delete-btn").onclick = async () => {
            if (
              collectionName === "guru" &&
              item.tasks &&
              item.tasks.length > 0
            ) {
              const taskNames = item.tasks
                .map((tid) => {
                  const task = allTugas.find((t) => t.id === tid);
                  return task ? task.name : tid;
                })
                .join(", ");
              if (
                !confirm(
                  `"${item.name}" memiliki ${item.tasks.length} tugas tambahan (${taskNames}). Yakin ingin menghapus?`
                )
              ) {
                return;
              }
            } else if (
              !confirm(
                `Apakah Anda yakin ingin menghapus "${item.name}"? Ini tidak bisa dibatalkan.`
              )
            ) {
              return;
            }
            deleteDoc(
              doc(
                db,
                `artifacts/${appId}/public/data/${collectionName}`,
                item.id
              )
            );
          };
          tr.querySelector(".edit-btn").onclick = () =>
            handleEditMasterData(collectionName, item.id, item.name);
          tbody.appendChild(tr);
        });
        container.innerHTML = "";
        container.appendChild(table);
      }

      function setupMasterDataView(
        sectionId,
        title,
        icon,
        collectionName,
        dataStore,
        onUpdateCallback = null
      ) {
        const section = document.getElementById(sectionId);
        section.innerHTML = `
                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                    <h4 class="font-bold text-slate-700 mb-3 flex items-center gap-2">${icon} <span>${title}</span></h4>
                    <form class="flex gap-2 mb-3">
                        <input type="text" placeholder="Tambah ${title} Baru..." class="add-input flex-grow p-2 border rounded-md bg-white text-sm" required>
                        <button type="submit" class="bg-blue-500 text-white px-3 rounded-md hover:bg-blue-600 font-bold text-lg">+</button>
                    </form>
                    <input type="text" placeholder="Cari ${title}..." class="search-input w-full p-2 border rounded-md bg-white text-sm mb-3">
                    <div class="max-h-60 overflow-y-auto">
                        <div class="table-container"></div>
                    </div>
                </div>
            `;

        const form = section.querySelector("form");
        const addInput = section.querySelector(".add-input");
        const searchInput = section.querySelector(".search-input");
        const tableContainer = section.querySelector(".table-container");
        const collRef = collection(
          db,
          `artifacts/${appId}/public/data/${collectionName}`
        );

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = addInput.value.trim();
          if (name === "") return;
          await addDoc(collRef, {
            name,
          });
          form.reset();
        });

        let items = [];
        onSnapshot(collRef, (snapshot) => {
          if (collectionName === "kelas") {
            items = snapshot.docs
              .map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }))
              .sort(customClassSort);
          } else {
            items = snapshot.docs
              .map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }))
              .sort((a, b) => a.name.localeCompare(b.name));
          }

          if (dataStore) {
            dataStore.length = 0;
            Array.prototype.push.apply(dataStore, items);
          }
          if (collectionName === "guru" || collectionName === "mapel") {
            const datalist = document.getElementById(
              `${collectionName}-list-datalist`
            );
            if (datalist) {
              datalist.innerHTML = "";
              items.forEach((item) =>
                datalist.appendChild(new Option(item.name, item.name))
              );
            }
          }

          if (collectionName === "guru") {
            const filterGuruDatalist = document.getElementById(
              "filter-guru-datalist"
            );
            const compareADatalist = document.getElementById(
              "compare-teacher-a-datalist"
            );
            const compareBDatalist = document.getElementById(
              "compare-teacher-b-datalist"
            );

            filterGuruDatalist.innerHTML = "";
            compareADatalist.innerHTML = "";
            compareBDatalist.innerHTML = "";

            items.forEach((item) => {
              filterGuruDatalist.appendChild(new Option(item.name, item.name));
              compareADatalist.appendChild(new Option(item.name, item.name));
              compareBDatalist.appendChild(new Option(item.name, item.name));
            });
          } else if (collectionName === "kelas") {
            const checkboxContainer = document.getElementById(
              "schedule-kelas-checkboxes"
            );
            // BARIS YANG DIPERBAIKI ADA DI BAWAH INI
            const filterKelasDatalist = document.getElementById(
              "filter-kelas-datalist"
            );
            checkboxContainer.innerHTML = "";
            filterKelasDatalist.innerHTML = "";
            items.forEach((item) => {
              const div = document.createElement("div");
              div.className = "flex items-center";
              div.innerHTML = `
                            <input id="class-${item.id}" type="checkbox" value="${item.name}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="class-${item.id}" class="ml-2 block text-sm text-gray-900">${item.name}</label>
                        `;
              checkboxContainer.appendChild(div);
              // Baris ini akan menambahkan kelas ke dalam daftar pencarian
              filterKelasDatalist.appendChild(new Option(item.name, item.name));
            });
          }

          renderMasterDataTable(
            tableContainer.id,
            items,
            collectionName,
            searchInput.value
          );
          if (onUpdateCallback) onUpdateCallback();
        });

        tableContainer.id = `${collectionName}-table-container`;
        searchInput.addEventListener("input", () => {
          renderMasterDataTable(
            tableContainer.id,
            items,
            collectionName,
            searchInput.value
          );
        });
      }
      function updateRealtimeClockAndHighlight() {
        const now = new Date();
        document.getElementById("clock-time").textContent =
          now.toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });

        document
          .querySelectorAll(".current-timeslot, .current-timeslot-header")
          .forEach((el) => {
            el.classList.remove("current-timeslot", "current-timeslot-header");
          });

        const currentDayIndex = now.getDay();
        if (currentDayIndex !== selectedDayIndex) return;

        const currentMinutes = now.getHours() * 60 + now.getMinutes();

        for (const slot of timeSlots) {
          const [start, end] = slot.time.split("-").map((t) => {
            const [h, m] = t.split(":").map(Number);
            return h * 60 + m;
          });

          if (currentMinutes >= start && currentMinutes < end) {
            const row = document.querySelector(
              `#guest-view tr[data-timeslot="${slot.time}"]`
            );
            if (row) {
              row
                .querySelectorAll("td")
                .forEach((cell) => cell.classList.add("current-timeslot"));
              if (row.querySelector('td:first-child[class*="bg-slate-50"]')) {
                row
                  .querySelector("td:first-child")
                  .classList.add("current-timeslot-header");
              }
            }
            break;
          }
        }
      }

      function populateJpSelects(startSelect, endSelect) {
        startSelect.innerHTML = '<option value="">Pilih JP</option>';
        timeSlots.forEach((slot) => {
          if (slot.type === "lesson") {
            startSelect.appendChild(
              new Option(`JP ${slot.jp} (${slot.time})`, slot.jp)
            );
          }
        });

        startSelect.addEventListener("change", () => {
          const startJp = parseInt(startSelect.value);
          endSelect.innerHTML = '<option value="">Sama</option>';
          if (!isNaN(startJp)) {
            timeSlots.forEach((slot) => {
              if (slot.type === "lesson" && slot.jp > startJp) {
                endSelect.appendChild(
                  new Option(`JP ${slot.jp} (${slot.time})`, slot.jp)
                );
              }
            });
          }
        });
      }

      function renderTeacherStats() {
        const container = document.getElementById("teacher-stats-container");
        container.innerHTML = "";

        if (allTeachers.length === 0) {
          container.innerHTML =
            '<p class="text-slate-500 col-span-full">Belum ada data guru untuk ditampilkan.</p>';
          return;
        }

        const teacherStats = {};

        // Initialize
        allTeachers.forEach((teacher) => {
          teacherStats[teacher.name] = { tasks: [], totalJp: 0 };
        });

        // Hitung JP dari mengajar (per mapel)
        const teacherMapelJp = {};
        allSchedules.forEach((schedule) => {
          if (
            schedule.guru &&
            !schedule.mapel.toLowerCase().includes("istirahat")
          ) {
            if (!teacherMapelJp[schedule.guru]) {
              teacherMapelJp[schedule.guru] = {};
            }
            if (!teacherMapelJp[schedule.guru][schedule.mapel]) {
              teacherMapelJp[schedule.guru][schedule.mapel] = 0;
            }
            const jpToAdd =
              jpCalculationMethod === "bySession" ? 1 : schedule.classes.length;
            teacherMapelJp[schedule.guru][schedule.mapel] += jpToAdd;
          }
        });

        // Add teaching tasks
        for (const teacherName in teacherMapelJp) {
          if (teacherStats[teacherName]) {
            for (const mapel in teacherMapelJp[teacherName]) {
              const jp = teacherMapelJp[teacherName][mapel];
              teacherStats[teacherName].tasks.push(`${mapel} (${jp} JP)`);
              teacherStats[teacherName].totalJp += jp;
            }
          }
        }

        // Add additional tasks
        allTeachers.forEach((teacher) => {
          if (teacher.tasks && teacher.tasks.length > 0) {
            teacher.tasks.forEach((taskId) => {
              const task = allTugas.find((t) => t.id === taskId);
              if (task) {
                teacherStats[teacher.name].tasks.push(
                  `${task.name} (${task.jp} JP)`
                );
                teacherStats[teacher.name].totalJp += task.jp;
              }
            });
          }
        });

        const sortedTeachers = [...allTeachers].sort((a, b) =>
          a.name.localeCompare(b.name)
        );

        sortedTeachers.forEach((teacher) => {
          const stats = teacherStats[teacher.name];
          const card = document.createElement("div");
          card.className = "bg-slate-50 border border-slate-200 p-4 rounded-xl";
          let tasksInfo =
            stats.tasks.length > 0
              ? `<div class="text-xs text-slate-600 mt-2">${stats.tasks.join(
                  "<br>"
                )}</div>`
              : '<div class="text-xs text-slate-500 mt-2">Belum ada tugas</div>';

          card.innerHTML = `
            <p class="font-semibold text-slate-800">${teacher.name}</p>
            <p class="text-3xl font-bold text-indigo-600 mt-1">${stats.totalJp} <span class="text-lg font-medium text-slate-500">Total JP</span></p>
            ${tasksInfo}
        `;
          container.appendChild(card);
        });
      }

      function checkForConflict(newData, currentId) {
        if (newData.mapel.toLowerCase().includes("istirahat")) {
          return null;
        }
        if (
          !newData.mapel.toLowerCase().includes("istirahat") &&
          !newData.guru
        ) {
          return { message: "Harap pilih guru untuk mata pelajaran ini." };
        }

        for (const className of newData.classes) {
          const classConflict = allSchedules.find(
            (s) =>
              s.day === newData.day &&
              s.jp == newData.jp &&
              s.classes.includes(className) &&
              s.id !== currentId
          );
          if (classConflict) {
            return {
              message: `Bentrok: Kelas ${className} sudah ada pelajaran "${classConflict.mapel}" pada JP ${newData.jp}.`,
            };
          }
        }

        const teacherConflict = allSchedules.find(
          (s) =>
            s.day === newData.day &&
            s.jp == newData.jp &&
            s.guru === newData.guru &&
            newData.guru !== "" &&
            s.id !== currentId
        );

        if (teacherConflict) {
          return {
            message: `Bentrok: ${
              newData.guru
            } sudah mengajar di kelas ${teacherConflict.classes.join(
              ", "
            )} pada JP ${newData.jp}.`,
          };
        }

        return null;
      }

      async function fetchAndDisplayPiket(dayIndex) {
        const container = document.getElementById("piket-content");
        container.innerHTML =
          '<p class="text-xs text-slate-400">Memuat data piket...</p>';
        const dayName = daysOfWeekApi[dayIndex];

        const piketTypeMap = {
          piket_dapur: { title: "Piket Dapur", icon: "🍳" },
          kelas_smp: { title: "Piket Kelas SMP", icon: "🏫" },
          kelas_smk: { title: "Piket Kelas SMK", icon: "🏢" },
          piket_laptop: { title: "Piket Laptop", icon: "💻" },
        };

        try {
          const piketApiRef = doc(
            db,
            `artifacts/${appId}/public/data/config`,
            "piketApi"
          );
          const apiDoc = await getDoc(piketApiRef);

          if (!apiDoc.exists() || !apiDoc.data().url) {
            container.innerHTML =
              '<p class="text-xs text-amber-600">URL API Piket belum diatur di panel admin.</p>';
            return;
          }

          const apiUrlWithQuery = apiDoc.data().url + `?hari=${dayName}`;
          const response = await fetch(apiUrlWithQuery);

          if (!response.ok) throw new Error("Gagal mengambil data dari API");

          const data = await response.json();
          if (data.status !== "success" || !data.data)
            throw new Error("Format API tidak valid");

          container.innerHTML = "";
          for (const type in piketTypeMap) {
            const piketDayData = data.data[type]?.[dayName];
            if (!piketDayData) continue;

            const card = document.createElement("div");
            card.className = "bg-slate-50 p-3 rounded-lg";

            let content = "";
            if (piketDayData.status === "puasa") {
              content =
                '<p class="text-sm font-medium text-slate-500">Puasa Senin-Kamis</p>';
            } else if (piketDayData.guru && piketDayData.guru.length > 0) {
              content = `<ul class="text-sm font-semibold text-slate-700">${piketDayData.guru
                .map((g) => `<li>${g}</li>`)
                .join("")}</ul>`;
            } else {
              content = '<p class="text-sm text-slate-400">- Tidak ada -</p>';
            }

            card.innerHTML = `
                        <p class="text-xs font-bold text-indigo-700">${piketTypeMap[type].icon} ${piketTypeMap[type].title}</p>
                        ${content}
                    `;
            container.appendChild(card);
          }
        } catch (error) {
          console.error("Error fetching piket data:", error);
          container.innerHTML = `<p class="text-xs text-red-600">Gagal memuat data piket. ${error.message}</p>`;
        }
      }

      function generatePrintableView(viewType) {
        const printContainer = document.getElementById("print-output");
        let contentHTML = "";
        let title = "";
        let tableHTML = "";

        const currentDate = new Date().toLocaleDateString("id-ID", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        if (viewType === "daily") {
          const dayName = daysOfWeek[selectedDayIndex];
          title = `Jadwal Pelajaran Hari ${dayName}`;
          const schedulesForDay = allSchedules.filter(
            (s) => s.day == selectedDayIndex
          );
          const teacherLegend = {};

          let headerHTML = `
            <div class="print-header">
                <h2>Jadwal Pelajaran Hari ${dayName}</h2>
                <h3 style="font-size: 14px; margin-top: 5px;">IDN Boarding School Pamijahan</h3>
                <p class="print-date">Dicetak pada: ${currentDate}</p>
            </div>
        `;

          let simplifiedTable = `<table class="w-full schedule-grid">
            <thead>
                <tr>
                    <th style="width: 12%;">Waktu</th>`;
          allClasses.forEach((c) => (simplifiedTable += `<th>${c.name}</th>`));
          simplifiedTable += "</tr></thead><tbody>";

          timeSlots.forEach((slot) => {
            if (slot.type === "break") {
              simplifiedTable += `<tr><td colspan="${
                allClasses.length + 1
              }" class="schedule-break-row">${
                slot.name
              }<br><span style="font-size: 8px;">(${
                slot.time
              })</span></td></tr>`;
            } else {
              simplifiedTable += `<tr><td class="font-semibold">JP ${slot.jp}<br><span style="font-size: 8px;">${slot.time}</span></td>`;

              let classIndex = 0;
              while (classIndex < allClasses.length) {
                const currentClass = allClasses[classIndex];
                const schedule = schedulesForDay.find(
                  (s) =>
                    s.jp == slot.jp && s.classes.includes(currentClass.name)
                );
                if (schedule) {
                  if (
                    schedule.guru &&
                    !schedule.mapel.toLowerCase().includes("istirahat")
                  ) {
                    if (!teacherLegend[schedule.mapel]) {
                      teacherLegend[schedule.mapel] = schedule.guru;
                    }
                  }
                  const isBreak = schedule.mapel
                    .toLowerCase()
                    .includes("istirahat");
                  const cellClass = isBreak ? "schedule-break-row" : "";

                  const scheduledClassesInOrder = allClasses.filter((c) =>
                    schedule.classes.includes(c.name)
                  );
                  const firstClassInSchedule = scheduledClassesInOrder[0];

                  if (currentClass.name === firstClassInSchedule.name) {
                    let span = 0;
                    let tempIndex = classIndex;
                    while (
                      tempIndex < allClasses.length &&
                      scheduledClassesInOrder.find(
                        (c) => c.name === allClasses[tempIndex].name
                      )
                    ) {
                      span++;
                      tempIndex++;
                    }
                    simplifiedTable += `<td class="${cellClass}" colspan="${span}"><strong>${schedule.mapel}</strong></td>`;
                    classIndex += span;
                  } else {
                    simplifiedTable += `<td>-</td>`;
                    classIndex++;
                  }
                } else {
                  simplifiedTable += `<td>-</td>`;
                  classIndex++;
                }
              }
              simplifiedTable += "</tr>";
            }
          });
          simplifiedTable += "</tbody></table>";

          let legendHTML = "";
          if (Object.keys(teacherLegend).length > 0) {
            legendHTML =
              '<div class="keterangan-guru"><h3>Keterangan Guru:</h3><ul>';
            const sortedMapel = Object.keys(teacherLegend).sort();
            sortedMapel.forEach((mapel) => {
              legendHTML += `<li><strong>${mapel}:</strong> ${teacherLegend[mapel]}</li>`;
            });
            legendHTML += "</ul></div>";
          }
          tableHTML = headerHTML + simplifiedTable + legendHTML;
        } else if (viewType === "teacher") {
          const teacherName = document
            .getElementById("teacher-schedule-title")
            .textContent.replace("Jadwal Mengajar: ", "");
          const teacherSchedules = allSchedules.filter(
            (s) => s.guru === teacherName
          );

          const teacherStats = {
            tasks: [],
            totalJp: 0,
          };
          const teacherMapelJp = {};

          teacherSchedules.forEach((schedule) => {
            if (!schedule.mapel.toLowerCase().includes("istirahat")) {
              if (!teacherMapelJp[schedule.mapel]) {
                teacherMapelJp[schedule.mapel] = 0;
              }
              const jpToAdd =
                jpCalculationMethod === "bySession"
                  ? 1
                  : schedule.classes.length;
              teacherMapelJp[schedule.mapel] += jpToAdd;
            }
          });

          for (const mapel in teacherMapelJp) {
            const jp = teacherMapelJp[mapel];
            teacherStats.tasks.push(`${mapel} (${jp} JP)`);
            teacherStats.totalJp += jp;
          }

          const teacher = allTeachers.find((t) => t.name === teacherName);
          if (teacher && teacher.tasks && teacher.tasks.length > 0) {
            teacher.tasks.forEach((taskId) => {
              const task = allTugas.find((t) => t.id === taskId);
              if (task) {
                teacherStats.tasks.push(`${task.name} (${task.jp} JP)`);
                teacherStats.totalJp += task.jp;
              }
            });
          }

          let headerHTML = `
            <div class="print-header">
                <h2>Jadwal Mengajar Guru</h2>
                <h3 style="font-size: 16px; margin-top: 8px;">${teacherName}</h3>
                <p class="print-date">Dicetak pada: ${currentDate}</p>
            </div>
        `;

          let summaryHTML = `
            <div class="stats-summary">
                <strong>Ringkasan Beban Mengajar:</strong><br>
                • Total JP: ${teacherStats.totalJp} JP<br>
                • Rincian Tugas:<br>
                ${teacherStats.tasks
                  .map((t) => `&nbsp;&nbsp;&nbsp;- ${t}`)
                  .join("<br>")}
            </div>
        `;

          let teacherTable =
            '<table class="w-full schedule-grid"><thead><tr><th style="width: 12%;">Waktu</th>';
          for (let i = 1; i <= 5; i++) {
            teacherTable += `<th>${daysOfWeek[i]}</th>`;
          }
          teacherTable += "</tr></thead><tbody>";

          timeSlots.forEach((slot) => {
            if (slot.type === "break") {
              teacherTable += `<tr><td colspan="6" class="schedule-break-row">${slot.name}<br><span style="font-size: 8px;">(${slot.time})</span></td></tr>`;
            } else {
              teacherTable += `<tr><td class="font-semibold">JP ${slot.jp}<br><span style="font-size: 8px;">${slot.time}</span></td>`;
              for (let j = 1; j <= 5; j++) {
                const schedule = allSchedules.find(
                  (s) => s.jp == slot.jp && s.day == j && s.guru === teacherName
                );
                if (schedule) {
                  const cellContent = `<strong>${
                    schedule.mapel
                  }</strong><br><span style="font-size: 8px;">${schedule.classes.join(
                    ", "
                  )}</span>`;
                  teacherTable += `<td style="background-color: #f0f9ff;">${cellContent}</td>`;
                } else {
                  teacherTable += `<td>-</td>`;
                }
              }
              teacherTable += "</tr>";
            }
          });
          teacherTable += "</tbody></table>";
          tableHTML = headerHTML + summaryHTML + teacherTable;
        } else if (viewType === "stats") {
          title = "Laporan Beban Tugas Guru per Minggu";
          const teacherStats = {};
          let totalAllJp = 0;

          allTeachers.forEach((teacher) => {
            teacherStats[teacher.name] = {
              tasks: [],
              totalJp: 0,
            };
          });

          const teacherMapelJp = {};
          allSchedules.forEach((schedule) => {
            if (
              schedule.guru &&
              !schedule.mapel.toLowerCase().includes("istirahat")
            ) {
              if (!teacherMapelJp[schedule.guru]) {
                teacherMapelJp[schedule.guru] = {};
              }
              if (!teacherMapelJp[schedule.guru][schedule.mapel]) {
                teacherMapelJp[schedule.guru][schedule.mapel] = 0;
              }
              const jpToAdd =
                jpCalculationMethod === "bySession"
                  ? 1
                  : schedule.classes.length;
              teacherMapelJp[schedule.guru][schedule.mapel] += jpToAdd;
            }
          });

          for (const teacherName in teacherMapelJp) {
            if (teacherStats[teacherName]) {
              for (const mapel in teacherMapelJp[teacherName]) {
                const jp = teacherMapelJp[teacherName][mapel];
                teacherStats[teacherName].tasks.push({
                  name: `Mengajar ${mapel}`,
                  jp,
                });
                teacherStats[teacherName].totalJp += jp;
              }
            }
          }

          allTeachers.forEach((teacher) => {
            if (teacher.tasks && teacher.tasks.length > 0) {
              teacher.tasks.forEach((taskId) => {
                const task = allTugas.find((t) => t.id === taskId);
                if (task) {
                  teacherStats[teacher.name].tasks.push({
                    name: task.name,
                    jp: task.jp,
                  });
                  teacherStats[teacher.name].totalJp += task.jp;
                }
              });
            }
          });

          const sortedTeachers = [...allTeachers].sort((a, b) =>
            a.name.localeCompare(b.name)
          );

          sortedTeachers.forEach((teacher) => {
            totalAllJp += teacherStats[teacher.name].totalJp;
          });

          const currentDate = new Date().toLocaleDateString("id-ID", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          let headerHTML = `
        <div class="print-header">
            <h2>LAPORAN BEBAN TUGAS GURU</h2>
            <h3 style="font-size: 14px; margin-top: 5px;">IDN Boarding School Pamijahan</h3>
            <p class="print-date">Dicetak pada: ${currentDate}</p>
        </div>
    `;

          let summaryHTML = `
        <div class="stats-summary">
            <strong>Ringkasan:</strong><br>
            • Total Guru: ${allTeachers.length} orang<br>
            • Total JP Keseluruhan: ${totalAllJp} JP<br>
            • Metode Perhitungan Mengajar: ${
              jpCalculationMethod === "bySession" ? "Per Sesi" : "Per Kelas"
            }
        </div>
    `;

          let statsTable = `<table class="w-full schedule-grid">
        <thead>
            <tr>
                <th style="width: 5%;">No</th>
                <th style="width: 30%;">Nama Guru</th>
                <th style="width: 50%;">Rincian Tugas</th>
                <th style="width: 15%; text-align: center;">Total JP</th>
            </tr>
        </thead>
        <tbody>`;

          sortedTeachers.forEach((teacher, index) => {
            const stats = teacherStats[teacher.name];
            const tasksDisplay =
              stats.tasks.length > 0
                ? stats.tasks.map((t) => `• ${t.name}: ${t.jp} JP`).join("<br>")
                : "-";

            statsTable += `
            <tr>
                <td style="text-align: center;">${index + 1}</td>
                <td><strong>${teacher.name}</strong></td>
                <td style="font-size: 9px;">${tasksDisplay}</td>
                <td style="text-align: center;"><strong>${
                  stats.totalJp
                }</strong></td>
            </tr>`;
          });

          statsTable += `
        <tr style="background-color: #e5e7eb; font-weight: bold;">
            <td colspan="3" style="text-align: right; padding-right: 10px;">TOTAL</td>
            <td style="text-align: center;">${totalAllJp}</td>
        </tr>
    </tbody></table>`;

          tableHTML = headerHTML + summaryHTML + statsTable;
        } else if (viewType === "class") {
          const className = document
            .getElementById("class-schedule-title")
            .textContent.replace("Jadwal Pelajaran: ", "");
          title = `Jadwal Pelajaran Kelas ${className}`;

          let headerHTML = `
            <div class="print-header">
                <h2>Jadwal Pelajaran Kelas ${className}</h2>
                <h3 style="font-size: 14px; margin-top: 5px;">IDN Boarding School Pamijahan</h3>
                <p class="print-date">Dicetak pada: ${currentDate}</p>
            </div>
        `;

          let classTable =
            '<table class="w-full schedule-grid"><thead><tr><th style="width: 12%;">Waktu</th>';
          for (let i = 1; i <= 5; i++) {
            classTable += `<th>${daysOfWeek[i]}</th>`;
          }
          classTable += "</tr></thead><tbody>";

          timeSlots.forEach((slot) => {
            if (slot.type === "break") {
              classTable += `<tr class="schedule-break-row"><td colspan="6">${slot.name}<br><span style="font-size: 8px;">(${slot.time})</span></td></tr>`;
            } else {
              classTable += `<tr><td class="font-semibold">JP ${slot.jp}<br><span style="font-size: 8px;">${slot.time}</span></td>`;
              for (let j = 1; j <= 5; j++) {
                const schedule = allSchedules.find(
                  (s) =>
                    s.jp == slot.jp &&
                    s.day == j &&
                    s.classes.includes(className)
                );
                if (schedule) {
                  const isBreak = schedule.mapel
                    .toLowerCase()
                    .includes("istirahat");
                  const cellClass = isBreak ? 'class="schedule-break-row"' : "";
                  const cellContent = `<strong>${
                    schedule.mapel
                  }</strong><br><span style="font-size: 8px;">${
                    schedule.guru || ""
                  }</span>`;
                  classTable += `<td ${cellClass}>${cellContent}</td>`;
                } else {
                  classTable += `<td>-</td>`;
                }
              }
              classTable += "</tr>";
            }
          });
          classTable += "</tbody></table>";
          tableHTML = headerHTML + classTable;
        }

        contentHTML = tableHTML;
        printContainer.innerHTML = contentHTML;
      }

      function displayClassScheduleView(className) {
        if (!className) {
          displayDailyScheduleView();
          return;
        }
        document.getElementById("daily-schedule-view").classList.add("hidden");
        document
          .getElementById("teacher-schedule-view")
          .classList.add("hidden");
        document
          .getElementById("class-schedule-view")
          .classList.remove("hidden");

        document.getElementById(
          "class-schedule-title"
        ).textContent = `Jadwal Pelajaran: ${className}`;

        let tableHTML =
          '<table class="w-full schedule-grid"><thead><tr><th>Waktu</th>';
        for (let i = 1; i <= 5; i++) {
          tableHTML += `<th>${daysOfWeek[i]}</th>`;
        }
        tableHTML += "</tr></thead><tbody>";

        const processedSlots = {}; // Untuk melacak sel yang sudah di-merge

        timeSlots.forEach((slot, slotIndex) => {
          if (slot.type === "break") {
            tableHTML += `<tr data-timeslot="${slot.time}" class="schedule-break-row"><td colspan="6">${slot.name} (${slot.time})</td></tr>`;
            return;
          }

          tableHTML += `<tr data-timeslot="${slot.time}"><td class="font-semibold bg-slate-50">JP ${slot.jp}<br><span class="text-xs font-normal">${slot.time}</span></td>`;
          for (let dayIndex = 1; dayIndex <= 5; dayIndex++) {
            const slotKey = `${dayIndex}-${slot.jp}`;
            if (processedSlots[slotKey]) {
              continue; // Lewati jika sel ini sudah menjadi bagian dari merge
            }

            const schedule = allSchedules.find(
              (s) =>
                s.jp == slot.jp &&
                s.day == dayIndex &&
                s.classes.includes(className)
            );

            if (schedule) {
              const isBreak = schedule.mapel
                .toLowerCase()
                .includes("istirahat");
              let rowspan = 1;

              if (isBreak) {
                // Logika untuk merge (rowspan) jika istirahat berlanjut
                for (
                  let nextSlotIndex = slotIndex + 1;
                  nextSlotIndex < timeSlots.length;
                  nextSlotIndex++
                ) {
                  const nextSlot = timeSlots[nextSlotIndex];
                  if (nextSlot.type !== "lesson") break;

                  const nextSchedule = allSchedules.find(
                    (s) =>
                      s.jp == nextSlot.jp &&
                      s.day == dayIndex &&
                      s.classes.includes(className) &&
                      s.mapel.toLowerCase().includes("istirahat")
                  );

                  if (nextSchedule) {
                    rowspan++;
                    processedSlots[`${dayIndex}-${nextSlot.jp}`] = true;
                  } else {
                    break;
                  }
                }
              }

              const cellClass = isBreak
                ? "schedule-break-row"
                : "hover:bg-indigo-50";
              const cellContent = isBreak
                ? `<strong>${schedule.mapel}</strong>`
                : `<div class="font-bold text-indigo-700">${
                    schedule.mapel
                  }</div><div class="text-xs text-slate-600">${
                    schedule.guru || ""
                  }</div>`;

              tableHTML += `<td class="${cellClass}" rowspan="${rowspan}">${cellContent}</td>`;
            } else {
              tableHTML += `<td>-</td>`;
            }
          }
          tableHTML += "</tr>";
        });

        tableHTML += "</tbody></table>";
        document.getElementById("class-schedule-content").innerHTML = tableHTML;
      }

      function renderMainView() {
        renderTeacherStats();
        const filterGuruInput = document.getElementById("filter-guru-input");
        if (
          filterGuruInput.value &&
          allTeachers.some((t) => t.name === filterGuruInput.value)
        ) {
          displayTeacherScheduleView(filterGuruInput.value);
        } else {
          displayDailyScheduleView();
        }
      }

      function renderAdminScheduleList(searchTerm = "") {
        const scheduleList = document.getElementById("schedule-list");
        scheduleList.innerHTML = "";
        const lowerCaseSearchTerm = searchTerm.toLowerCase();

        const filteredSchedules = lowerCaseSearchTerm
          ? allSchedules.filter(
              (s) =>
                (s.guru &&
                  s.guru.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (s.mapel && s.mapel.toLowerCase().includes(lowerCaseSearchTerm))
            )
          : allSchedules;

        filteredSchedules
          .sort((a, b) => a.day - b.day || a.jp - b.jp)
          .forEach((s) => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-50 transition-colors";
            tr.innerHTML = `<td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-slate-700">${
              daysOfWeek[parseInt(s.day)]
            }</td><td class="px-4 py-3 text-sm text-slate-600">${
              s.jp
            }</td><td class="px-4 py-3 text-sm text-slate-600">${s.classes.join(
              ", "
            )}</td><td class="px-4 py-3 text-sm text-slate-600">${
              s.mapel
            }</td><td class="px-4 py-3 text-sm text-slate-600">${
              s.guru || "-"
            }</td><td class="px-4 py-3 text-center"><div class="flex items-center justify-center space-x-2"><button class="edit-btn p-2 text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg></button><button class="delete-btn p-2 text-red-600 bg-red-100 rounded-md hover:bg-red-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></td>`;
            tr.querySelector(".delete-btn").onclick = () => {
              if (confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) {
                deleteDoc(
                  doc(db, `artifacts/${appId}/public/data/schedules`, s.id)
                );
              }
            };
            tr.querySelector(".edit-btn").onclick = () => {
              const scheduleForm = document.getElementById("schedule-form");
              scheduleForm.reset();
              document
                .querySelectorAll("#schedule-kelas-checkboxes input")
                .forEach((cb) => {
                  cb.checked = false;
                  cb.disabled = false;
                });
              updateClassSelectionLimit();

              document.getElementById("schedule-id").value = s.id;
              document.getElementById("schedule-day").value = s.day;
              document.getElementById("schedule-jp-start").value = s.jp;
              document
                .getElementById("schedule-jp-start")
                .dispatchEvent(new Event("change"));
              document.getElementById("schedule-jp-end").disabled = true;

              document.getElementById("schedule-mapel-input").value = s.mapel;
              document.getElementById("schedule-guru-input").value =
                s.guru || "";

              s.classes.forEach((className) => {
                const checkbox = document.querySelector(
                  `#schedule-kelas-checkboxes input[value="${className}"]`
                );
                if (checkbox) checkbox.checked = true;
              });

              const scheduleGuruInput = document.getElementById(
                "schedule-guru-input"
              );
              if (s.mapel.toLowerCase().includes("istirahat")) {
                scheduleGuruInput.disabled = true;
              } else {
                scheduleGuruInput.disabled = false;
              }
              updateClassSelectionLimit();

              window.scrollTo({ top: 0, behavior: "smooth" });
            };
            scheduleList.appendChild(tr);
          });
      }

      const scheduleKelasCheckboxes = document.getElementById(
        "schedule-kelas-checkboxes"
      );
      const scheduleMapelInput = document.getElementById(
        "schedule-mapel-input"
      );
      const scheduleGuruInput = document.getElementById("schedule-guru-input");
      const classLimitLabel = document.getElementById("class-limit-label");

      function updateClassSelectionLimit() {
        const isBreak = scheduleMapelInput.value
          .toLowerCase()
          .includes("istirahat");
        classLimitLabel.style.display = isBreak ? "none" : "inline";

        if (isBreak) {
          scheduleKelasCheckboxes
            .querySelectorAll("input")
            .forEach((cb) => (cb.disabled = false));
          return;
        }

        const checkedCount =
          scheduleKelasCheckboxes.querySelectorAll("input:checked").length;
        const allCheckboxes = scheduleKelasCheckboxes.querySelectorAll("input");
        if (checkedCount >= 3) {
          allCheckboxes.forEach((cb) => {
            if (!cb.checked) cb.disabled = true;
          });
        } else {
          allCheckboxes.forEach((cb) => (cb.disabled = false));
        }
      }

      async function getAiSuggestion() {
        const btn = document.getElementById("ai-suggestion-btn");
        const conflictResultsContainer = document.getElementById(
          "conflict-results-container"
        );
        const conflictResults = document.getElementById("conflict-results");

        conflictResultsContainer.style.display = "block";
        conflictResults.textContent = "🧠 Meminta saran dari Gemini AI...";
        btn.disabled = true;

        try {
          if (
            allClasses.length === 0 ||
            allTeachers.length === 0 ||
            allMapel.length === 0
          ) {
            throw new Error(
              "Data master (kelas, guru, mapel) harus lengkap untuk memberikan saran."
            );
          }

          const teacherWorkload = {};
          const teacherSubjectMap = {};
          allTeachers.forEach((teacher) => {
            teacherWorkload[teacher.name] = 0;
            teacherSubjectMap[teacher.name] = new Set();
          });
          allSchedules.forEach((schedule) => {
            if (
              schedule.guru &&
              !schedule.mapel.toLowerCase().includes("istirahat")
            ) {
              const jpToAdd =
                jpCalculationMethod === "bySession"
                  ? 1
                  : schedule.classes.length;
              if (teacherWorkload.hasOwnProperty(schedule.guru)) {
                teacherWorkload[schedule.guru] += jpToAdd;
              }
              if (teacherSubjectMap.hasOwnProperty(schedule.guru)) {
                teacherSubjectMap[schedule.guru].add(schedule.mapel);
              }
            }
          });
          for (const teacher in teacherSubjectMap) {
            teacherSubjectMap[teacher] = Array.from(teacherSubjectMap[teacher]);
          }

          const prompt = `
                    Anda adalah seorang ahli optimasi jadwal sekolah yang berpengalaman. Tugas Anda adalah menganalisis data jadwal yang ada dan memberikan satu saran konkret untuk membuatnya lebih seimbang dan efisien.

                    Data Konteks:
                    - Jadwal yang ada: ${JSON.stringify(allSchedules)}
                    - Daftar Guru: ${JSON.stringify(
                      allTeachers.map((t) => t.name)
                    )}
                    - Daftar Mata Pelajaran: ${JSON.stringify(
                      allMapel
                        .map((m) => m.name)
                        .filter((m) => !m.toLowerCase().includes("istirahat"))
                    )}
                    - Daftar Kelas: ${JSON.stringify(
                      allClasses.map((c) => c.name)
                    )}
                    - Beban Mengajar Saat Ini (metode: ${jpCalculationMethod}): ${JSON.stringify(
            teacherWorkload
          )}
                    - Peta Kemampuan Guru (guru hanya bisa mengajar mapel yang terdaftar di sini): ${JSON.stringify(
                      teacherSubjectMap
                    )}

                    Aturan dan Kendala:
                    1. Fokus utama Anda adalah menyeimbangkan beban mengajar. Identifikasi guru dengan JP terbanyak dan guru dengan JP paling sedikit (yang bisa mengajar mata pelajaran yang sama).
                    2. Jangan mengubah mata pelajaran yang diajar oleh seorang guru.
                    3. Untuk guru IT (yang namanya mengandung 'IT' atau mengajar mapel yang mengandung 'IT'), mereka sangat terspesialisasi. Hindari memindahkan jadwal IT kecuali jika benar-benar tidak ada pilihan lain untuk menyeimbangkan beban.
                    4. Saran harus berupa satu tindakan spesifik yang dapat dieksekusi, seperti memindahkan satu sesi pelajaran dari guru yang sibuk ke guru yang lebih luang.
                    5. Pastikan saran yang diberikan tidak menimbulkan konflik baru (guru atau kelas tidak boleh dijadwalkan ganda).

                    Tugas:
                    Berikan analisis singkat tentang ketidakseimbangan yang Anda temukan, lalu berikan satu saran konkret. Jika tidak ada ketidakseimbangan yang signifikan, nyatakan bahwa jadwal sudah cukup seimbang.

                    Format output Anda HARUS berupa JSON yang valid.
                `;

          const apiKey = "";
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

          const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  analysis: {
                    type: "STRING",
                    description:
                      "Analisis singkat tentang ketidakseimbangan beban mengajar atau masalah lain yang ditemukan.",
                  },
                  suggestion: {
                    type: "STRING",
                    description:
                      "Satu saran konkret untuk perbaikan, atau pernyataan bahwa jadwal sudah baik.",
                  },
                },
                required: ["analysis", "suggestion"],
              },
            },
          };

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(`API Error: ${response.statusText} - ${errorBody}`);
          }

          const result = await response.json();
          if (
            !result.candidates ||
            !result.candidates[0].content.parts[0].text
          ) {
            throw new Error("Respon dari AI tidak valid atau kosong.");
          }

          const jsonText = result.candidates[0].content.parts[0].text;
          const suggestion = JSON.parse(jsonText);

          const suggestionText = `Analisis AI:\n${suggestion.analysis}\n\nSaran:\n${suggestion.suggestion}`;
          conflictResults.textContent = suggestionText;
        } catch (error) {
          console.error("AI Suggestion Error:", error);
          conflictResults.textContent = `Gagal mendapatkan saran AI: ${error.message}`;
        } finally {
          btn.disabled = false;
        }
      }

      function init() {
        const todayIndex = new Date().getDay();
        selectedDayIndex =
          todayIndex === 0 || todayIndex === 6 ? 1 : todayIndex;

        document
          .getElementById("filter-guru-input")
          .addEventListener("change", (e) => {
            const selectedTeacher = e.target.value;
            if (allTeachers.some((t) => t.name === selectedTeacher)) {
              document.getElementById("filter-kelas-input").value = "";
              displayTeacherScheduleView(selectedTeacher);
            } else if (selectedTeacher === "") {
              displayDailyScheduleView();
            }
          });

        document
          .getElementById("filter-kelas-input")
          .addEventListener("change", (e) => {
            const selectedClass = e.target.value;
            if (allClasses.some((c) => c.name === selectedClass)) {
              document.getElementById("filter-guru-input").value = "";
              displayClassScheduleView(selectedClass);
            } else if (selectedClass === "") {
              displayDailyScheduleView();
            }
          });

        document
          .getElementById("admin-search-input")
          .addEventListener("input", (e) =>
            renderAdminScheduleList(e.target.value)
          );

        document
          .getElementById("print-button-daily")
          .addEventListener("click", () => {
            generatePrintableView("daily");
            window.print();
          });
        document
          .getElementById("print-button-teacher")
          .addEventListener("click", () => {
            generatePrintableView("teacher");
            window.print();
          });
        document
          .getElementById("print-button-class")
          .addEventListener("click", () => {
            generatePrintableView("class");
            window.print();
          });
        document
          .getElementById("print-stats-button")
          .addEventListener("click", () => {
            generatePrintableView("stats");
            window.print();
          });

        const scheduleDaySelect = document.getElementById("schedule-day");
        for (let i = 1; i <= 5; i++)
          scheduleDaySelect.appendChild(new Option(daysOfWeek[i], i));

        populateJpSelects(
          document.getElementById("schedule-jp-start"),
          document.getElementById("schedule-jp-end")
        );

        scheduleKelasCheckboxes.addEventListener(
          "change",
          updateClassSelectionLimit
        );
        scheduleMapelInput.addEventListener("input", (e) => {
          const isBreak = e.target.value.toLowerCase().includes("istirahat");
          if (isBreak) {
            scheduleGuruInput.value = "";
            scheduleGuruInput.disabled = true;
          } else {
            scheduleGuruInput.disabled = false;
          }
          updateClassSelectionLimit();
        });

        document.getElementById("auth-button").addEventListener("click", () => {
          if (auth.currentUser) signOut(auth);
          else
            signInWithPopup(auth, provider).catch((error) =>
              console.error("Login Gagal:", error.message)
            );
        });

        onAuthStateChanged(auth, async (user) => {
          const adminView = document.getElementById("admin-view");
          const guestView = document.getElementById("guest-view");
          const piketApiUrlInput = document.getElementById("piket-api-url");
          const piketApiRef = doc(
            db,
            `artifacts/${appId}/public/data/config`,
            "piketApi"
          );

          if (user && (await isAdmin(user.uid))) {
            document.getElementById("auth-button-text").textContent = "Logout";
            adminView.classList.remove("hidden");
            guestView.classList.add("hidden");
            const apiDoc = await getDoc(piketApiRef);
            if (apiDoc.exists()) {
              piketApiUrlInput.value = apiDoc.data().url;
            }
          } else {
            if (user) {
              showToast(
                "Login berhasil, tapi Anda tidak memiliki akses admin."
              );
              signOut(auth);
            }
            document.getElementById("auth-button-text").textContent =
              "Login Admin";
            adminView.classList.add("hidden");
            guestView.classList.remove("hidden");
          }
        });

        const tabs = {
          "tab-jadwal": "admin-content-jadwal",
          "tab-master": "admin-content-master",
          "tab-tugas": "admin-content-tugas",
          "tab-statistik": "admin-content-statistik",
          "tab-ai-tools": "admin-content-ai-tools",
          "tab-export": "admin-content-export",
          "tab-info": "admin-content-info",
        };

        Object.keys(tabs).forEach((tabId) => {
          document.getElementById(tabId).addEventListener("click", () => {
            Object.keys(tabs).forEach((t) => {
              document.getElementById(t).classList.remove("active");
              document.getElementById(tabs[t]).classList.add("hidden");
            });
            document.getElementById(tabId).classList.add("active");
            document.getElementById(tabs[tabId]).classList.remove("hidden");
          });
        });

        const onMasterDataUpdate = () => {
          renderMainView();
          renderAdminScheduleList(
            document.getElementById("admin-search-input").value
          );
        };

        setupMasterDataView(
          "kelas-management-section",
          "Manajemen Kelas",
          "🏫",
          "kelas",
          allClasses,
          onMasterDataUpdate
        );
        setupMasterDataView(
          "guru-management-section",
          "Manajemen Guru",
          "👩‍🏫",
          "guru",
          allTeachers,
          onMasterDataUpdate
        );
        setupMasterDataView(
          "mapel-management-section",
          "Manajemen Mapel",
          "📚",
          "mapel",
          allMapel,
          onMasterDataUpdate
        );

        let currentTeacherForAssignment = null;

        const tugasCollRef = collection(
          db,
          `artifacts/${appId}/public/data/tugas`
        );

        onSnapshot(tugasCollRef, (snapshot) => {
          allTugas = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));
          renderTugasList();
          renderTeacherAssignmentList();
          renderTeacherStats();
        });

        document
          .getElementById("tugas-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("tugas-id").value;
            const name = document.getElementById("tugas-name").value.trim();
            const jp = parseInt(document.getElementById("tugas-jp").value);

            if (name && jp > 0) {
              if (id) {
                await setDoc(
                  doc(db, `artifacts/${appId}/public/data/tugas`, id),
                  {
                    name,
                    jp,
                  }
                );
                showToast("Jabatan berhasil diperbarui!");
              } else {
                await addDoc(tugasCollRef, {
                  name,
                  jp,
                });
                showToast("Jabatan berhasil ditambahkan!");
              }
              document.getElementById("clear-tugas-btn").click();
            }
          });

        document
          .getElementById("clear-tugas-btn")
          .addEventListener("click", () => {
            document.getElementById("tugas-form").reset();
            document.getElementById("tugas-id").value = "";
            document
              .getElementById("tugas-form")
              .querySelector('button[type="submit"]').textContent =
              "Tambah Jabatan";
          });

        document
          .getElementById("tugas-search")
          .addEventListener("input", renderTugasList);

        function renderTugasList() {
          const list = document.getElementById("tugas-list");
          const searchInput = document.getElementById("tugas-search");
          const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";

          list.innerHTML = "";

          if (allTugas.length === 0) {
            list.innerHTML =
              '<li class="text-sm text-slate-500 text-center py-4">Belum ada jabatan.</li>';
            return;
          }

          const filteredTugas = searchTerm
            ? allTugas.filter((t) => t.name.toLowerCase().includes(searchTerm))
            : allTugas;

          if (filteredTugas.length === 0) {
            list.innerHTML =
              '<li class="text-sm text-slate-500 text-center py-4">Tidak ada jabatan ditemukan.</li>';
            return;
          }

          filteredTugas.forEach((tugas) => {
            const li = document.createElement("li");
            li.className =
              "bg-white p-3 rounded-lg flex justify-between items-center shadow-sm";
            li.innerHTML = `
            <div>
                <span class="text-sm font-semibold text-slate-700">${tugas.name}</span>
                <span class="text-xs text-indigo-600 ml-2">(${tugas.jp} JP)</span>
            </div>
            <div class="flex space-x-2">
                <button class="edit-btn p-2 text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg>
                </button>
                <button class="delete-btn p-2 text-red-600 bg-red-100 rounded-md hover:bg-red-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>
        `;

            li.querySelector(".edit-btn").onclick = () => {
              document.getElementById("tugas-id").value = tugas.id;
              document.getElementById("tugas-name").value = tugas.name;
              document.getElementById("tugas-jp").value = tugas.jp;
              document
                .getElementById("tugas-form")
                .querySelector('button[type="submit"]').textContent =
                "Update Jabatan";
            };

            li.querySelector(".delete-btn").onclick = async () => {
              if (confirm(`Hapus jabatan "${tugas.name}"?`)) {
                await deleteDoc(
                  doc(db, `artifacts/${appId}/public/data/tugas`, tugas.id)
                );
                showToast("Jabatan berhasil dihapus!");
              }
            };
            list.appendChild(li);
          });
        }

        function renderTeacherAssignmentList() {
          const container = document.getElementById("teacher-assignment-list");
          const searchInput = document.getElementById("teacher-search");
          const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";

          container.innerHTML = "";

          if (allTeachers.length === 0) {
            container.innerHTML =
              '<p class="text-sm text-slate-500 text-center py-4">Belum ada data guru.</p>';
            return;
          }

          const sortedTeachers = [...allTeachers].sort((a, b) =>
            a.name.localeCompare(b.name)
          );
          const filteredTeachers = searchTerm
            ? sortedTeachers.filter((t) =>
                t.name.toLowerCase().includes(searchTerm)
              )
            : sortedTeachers;

          if (filteredTeachers.length === 0) {
            container.innerHTML =
              '<p class="text-sm text-slate-500 text-center py-4">Tidak ada guru ditemukan.</p>';
            return;
          }

          filteredTeachers.forEach((teacher) => {
            const assignedTasks = teacher.tasks || [];
            const taskCount = assignedTasks.length;

            const div = document.createElement("div");
            div.className = "bg-white p-3 rounded-lg shadow-sm";
            div.innerHTML = `
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm font-semibold text-slate-700">${teacher.name}</p>
                    <p class="text-xs text-slate-500">${taskCount} tugas tambahan</p>
                </div>
                <button class="bg-indigo-600 text-white text-xs px-3 py-1.5 rounded-md hover:bg-indigo-700 font-semibold">
                    Kelola Tugas
                </button>
            </div>
        `;
            div.querySelector("button").onclick = () =>
              openAssignmentModal(teacher);
            container.appendChild(div);
          });
        }

        document
          .getElementById("teacher-search")
          .addEventListener("input", renderTeacherAssignmentList);

        function openAssignmentModal(teacher) {
          currentTeacherForAssignment = teacher;
          const modal = document.getElementById("assignment-modal");
          const title = document.getElementById("assignment-modal-title");
          const body = document.getElementById("assignment-modal-body");

          title.textContent = `Kelola Tugas: ${teacher.name}`;
          body.innerHTML = "";

          if (allTugas.length === 0) {
            body.innerHTML =
              '<p class="text-sm text-slate-500 text-center py-4">Belum ada jabatan. Tambahkan jabatan terlebih dahulu.</p>';
            modal.classList.remove("hidden");
            return;
          }

          const checkedTasks = new Set(teacher.tasks || []);

          const searchDiv = document.createElement("div");
          searchDiv.className = "mb-3";
          searchDiv.innerHTML =
            '<input type="text" id="modal-task-search" placeholder="Cari tugas..." class="w-full p-2 border rounded-md text-sm">';
          body.appendChild(searchDiv);

          const tasksContainer = document.createElement("div");
          tasksContainer.id = "modal-tasks-container";
          tasksContainer.className = "max-h-60 overflow-y-auto";
          body.appendChild(tasksContainer);

          function renderModalTasks(searchTerm = "") {
            const lowerSearch = searchTerm.toLowerCase();
            const filteredTugas = searchTerm
              ? allTugas.filter((t) =>
                  t.name.toLowerCase().includes(lowerSearch)
                )
              : allTugas;

            tasksContainer.innerHTML = "";

            if (filteredTugas.length === 0) {
              tasksContainer.innerHTML =
                '<p class="text-sm text-slate-500 py-2">Tidak ada tugas ditemukan.</p>';
              return;
            }

            filteredTugas.forEach((tugas) => {
              const div = document.createElement("div");
              div.className =
                "flex items-center py-2 px-2 hover:bg-slate-50 rounded";

              const isChecked = checkedTasks.has(tugas.id);

              div.innerHTML = `
                <input type="checkbox" id="task-${tugas.id}" ${
                isChecked ? "checked" : ""
              } 
                       class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                       data-task-id="${tugas.id}">
                <label for="task-${
                  tugas.id
                }" class="ml-3 text-sm text-slate-700 cursor-pointer flex-1">
                    <span class="font-semibold">${tugas.name}</span>
                    <span class="text-indigo-600 ml-1">(${tugas.jp} JP)</span>
                </label>
            `;

              const checkbox = div.querySelector('input[type="checkbox"]');
              checkbox.addEventListener("change", (e) => {
                const taskId = e.target.dataset.taskId;
                if (e.target.checked) {
                  checkedTasks.add(taskId);
                } else {
                  checkedTasks.delete(taskId);
                }
                console.log("Current checked tasks:", Array.from(checkedTasks));
              });

              tasksContainer.appendChild(div);
            });
          }

          renderModalTasks();

          const searchInput = searchDiv.querySelector("#modal-task-search");
          searchInput.addEventListener("input", (e) => {
            renderModalTasks(e.target.value);
          });

          modal.classList.remove("hidden");
        }

        document
          .getElementById("assignment-modal-save")
          .addEventListener("click", async () => {
            if (!currentTeacherForAssignment) {
              showToast("Terjadi kesalahan. Silakan coba lagi.");
              return;
            }

            const tasksContainer = document.getElementById(
              "modal-tasks-container"
            );
            const selectedTasks = Array.from(
              tasksContainer.querySelectorAll('input[type="checkbox"]:checked')
            ).map((cb) => cb.dataset.taskId);

            console.log("Saving tasks for", currentTeacherForAssignment.name);
            console.log("Selected task IDs:", selectedTasks);
            console.log("Total tasks:", selectedTasks.length);

            if (selectedTasks.length === 0) {
              if (
                !confirm(
                  "Tidak ada tugas yang dipilih. Yakin ingin menghapus semua tugas untuk guru ini?"
                )
              ) {
                return;
              }
            }

            try {
              const teacherDocRef = doc(
                db,
                `artifacts/${appId}/public/data/guru`,
                currentTeacherForAssignment.id
              );
              await setDoc(
                teacherDocRef,
                {
                  name: currentTeacherForAssignment.name,
                  tasks: selectedTasks,
                },
                {
                  merge: true,
                }
              );

              document
                .getElementById("assignment-modal")
                .classList.add("hidden");
              showToast(
                `${selectedTasks.length} tugas berhasil disimpan untuk ${currentTeacherForAssignment.name}!`
              );
              currentTeacherForAssignment = null;
            } catch (error) {
              console.error("Error saving tasks:", error);
              showToast("Gagal menyimpan. Cek console untuk detail.");
            }
          });
        document
          .getElementById("assignment-modal-close")
          .addEventListener("click", () => {
            document.getElementById("assignment-modal").classList.add("hidden");
            currentTeacherForAssignment = null;
          });

        const piketApiForm = document.getElementById("piket-api-form");
        piketApiForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const url = document.getElementById("piket-api-url").value;
          const piketApiRef = doc(
            db,
            `artifacts/${appId}/public/data/config`,
            "piketApi"
          );
          await setDoc(piketApiRef, {
            url: url,
          });
          showToast("URL API Piket berhasil disimpan!");
          fetchAndDisplayPiket(selectedDayIndex);
        });

        const jpConfigRef = doc(
          db,
          `artifacts/${appId}/public/data/config`,
          "jpCalculation"
        );
        onSnapshot(jpConfigRef, (docSnap) => {
          if (docSnap.exists() && docSnap.data().method) {
            jpCalculationMethod = docSnap.data().method;
            if (jpCalculationMethod === "bySession") {
              document.getElementById("jp-by-session").checked = true;
            } else {
              document.getElementById("jp-by-class").checked = true;
            }
          } else {
            document.getElementById("jp-by-class").checked = true;
          }
          renderTeacherStats();
        });

        const jpSettingsContainer = document.getElementById(
          "jp-calculation-settings"
        );
        jpSettingsContainer.addEventListener("change", async (e) => {
          if (e.target.name === "jp-calculation") {
            const newMethod = e.target.value;
            await setDoc(jpConfigRef, {
              method: newMethod,
            });
            showToast("Pengaturan perhitungan JP berhasil disimpan!");
          }
        });

        const scheduleForm = document.getElementById("schedule-form");
        scheduleForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("schedule-id").value;
          const mapelValue = document.getElementById(
            "schedule-mapel-input"
          ).value;
          const guruValue = mapelValue.toLowerCase().includes("istirahat")
            ? ""
            : document.getElementById("schedule-guru-input").value;
          const selectedClasses = Array.from(
            document.querySelectorAll(
              "#schedule-kelas-checkboxes input:checked"
            )
          ).map((cb) => cb.value);

          if (selectedClasses.length === 0) {
            showToast("Pilih setidaknya satu kelas.");
            return;
          }

          const startJp = parseInt(
            document.getElementById("schedule-jp-start").value
          );
          const endJpValue = document.getElementById("schedule-jp-end").value;
          const endJp = endJpValue ? parseInt(endJpValue) : startJp;

          if (isNaN(startJp)) {
            showToast("Pilih JP awal.");
            return;
          }

          if (id) {
            const scheduleData = {
              day: document.getElementById("schedule-day").value,
              jp: startJp,
              classes: selectedClasses,
              guru: guruValue,
              mapel: mapelValue,
            };
            const conflict = checkForConflict(scheduleData, id);
            if (conflict) {
              showToast(conflict.message);
              return;
            }
            const docRef = doc(
              db,
              `artifacts/${appId}/public/data/schedules`,
              id
            );
            await setDoc(docRef, scheduleData);
            showToast("Jadwal berhasil diperbarui!");
          } else {
            let conflicts = [];
            for (let jp = startJp; jp <= endJp; jp++) {
              const tempScheduleData = {
                day: document.getElementById("schedule-day").value,
                jp: jp,
                classes: selectedClasses,
                guru: guruValue,
                mapel: mapelValue,
              };
              const conflict = checkForConflict(tempScheduleData, null); // Always check for new conflicts when adding
              if (conflict) conflicts.push(conflict.message);
            }
            if (conflicts.length > 0) {
              showToast(conflicts.join("\n"));
              return;
            }
            for (let jp = startJp; jp <= endJp; jp++) {
              const scheduleData = {
                day: document.getElementById("schedule-day").value,
                jp: jp,
                classes: selectedClasses,
                guru: guruValue,
                mapel: mapelValue,
              };
              const docRef = collection(
                db,
                `artifacts/${appId}/public/data/schedules`
              );
              await addDoc(docRef, scheduleData);
            }
            showToast(
              `Jadwal untuk JP ${startJp} - ${endJp} berhasil ditambahkan!`
            );
          }

          document.getElementById("clear-form-btn").click();
        });

        document
          .getElementById("clear-form-btn")
          .addEventListener("click", () => {
            scheduleForm.reset();
            document.getElementById("schedule-id").value = "";
            document.getElementById("schedule-guru-input").disabled = false;
            document
              .querySelectorAll("#schedule-kelas-checkboxes input")
              .forEach((cb) => {
                cb.checked = false;
                cb.disabled = false;
              });
            updateClassSelectionLimit();
            document.getElementById("schedule-jp-end").disabled = false;
          });

        onSnapshot(
          collection(db, `artifacts/${appId}/public/data/schedules`),
          (snapshot) => {
            allSchedules = snapshot.docs.map((doc) => {
              const data = doc.data();
              if (data.kelas && !Array.isArray(data.classes)) {
                data.classes = [data.kelas];
              } else if (!Array.isArray(data.classes)) {
                data.classes = [];
              }
              return {
                id: doc.id,
                ...data,
              };
            });
            onMasterDataUpdate();
          }
        );

        document
          .getElementById("check-conflicts-btn")
          .addEventListener("click", () => {
            const conflicts = [];
            const slots = {}; // key: day-jp-teacher or day-jp-class
            allSchedules.forEach((s) => {
              const keyBase = `${s.day}-${s.jp}`;
              if (s.guru) {
                const teacherKey = `${keyBase}-${s.guru}`;
                if (slots[teacherKey]) {
                  conflicts.push(
                    `Guru ${s.guru} dijadwalkan ganda pada ${
                      daysOfWeek[s.day]
                    } JP ${s.jp} (di kelas ${
                      slots[teacherKey]
                    } dan ${s.classes.join(", ")})`
                  );
                }
                slots[teacherKey] = s.classes.join(", ");
              }
              s.classes.forEach((c) => {
                const classKey = `${keyBase}-${c}`;
                if (slots[classKey]) {
                  conflicts.push(
                    `Kelas ${c} dijadwalkan ganda pada ${
                      daysOfWeek[s.day]
                    } JP ${s.jp} (mapel ${slots[classKey]} dan ${s.mapel})`
                  );
                }
                slots[classKey] = s.mapel;
              });
            });

            const resultsContainer = document.getElementById(
              "conflict-results-container"
            );
            const resultsEl = document.getElementById("conflict-results");
            resultsContainer.style.display = "block";
            if (conflicts.length > 0) {
              resultsEl.innerHTML = conflicts.join("\n\n");
            } else {
              resultsEl.innerHTML =
                "👍 Tidak ditemukan konflik di seluruh jadwal.";
            }
          });

        document
          .getElementById("compare-teachers-btn")
          .addEventListener("click", () => {
            const teacherA = document.getElementById(
              "compare-teacher-a-input"
            ).value;
            const teacherB = document.getElementById(
              "compare-teacher-b-input"
            ).value;

            if (!teacherA || !teacherB) {
              showToast("Harap pilih kedua guru untuk dibandingkan.");
              return;
            }
            if (teacherA === teacherB) {
              showToast("Harap pilih dua guru yang berbeda.");
              return;
            }

            const resultsContainer = document.getElementById(
              "conflict-results-container"
            );
            const resultsEl = document.getElementById("conflict-results");
            resultsContainer.style.display = "block";

            let tableHTML = `<table class="w-full schedule-grid"><thead><tr><th>Waktu</th>`;
            for (let i = 1; i <= 5; i++) {
              tableHTML += `<th>${daysOfWeek[i]}</th>`;
            }
            tableHTML += "</tr></thead><tbody>";

            timeSlots.forEach((slot) => {
              if (slot.type !== "lesson") return;
              tableHTML += `<tr><td class="font-semibold bg-slate-50">JP ${slot.jp}<br><span class="text-xs font-normal">${slot.time}</span></td>`;
              for (let j = 1; j <= 5; j++) {
                const scheduleA = allSchedules.find(
                  (s) => s.jp == slot.jp && s.day == j && s.guru === teacherA
                );
                const scheduleB = allSchedules.find(
                  (s) => s.jp == slot.jp && s.day == j && s.guru === teacherB
                );

                if (scheduleA && scheduleB) {
                  tableHTML += `<td class="bg-red-100 text-red-700">
                                <div class="font-bold">${teacherA}: ${scheduleA.classes.join(
                    ", "
                  )}</div>
                                <div class="font-bold">${teacherB}: ${scheduleB.classes.join(
                    ", "
                  )}</div>
                             </td>`;
                } else {
                  tableHTML += `<td>-</td>`;
                }
              }
              tableHTML += "</tr>";
            });
            tableHTML += "</tbody></table>";

            resultsEl.innerHTML = tableHTML;
          });

        document
          .getElementById("ai-suggestion-btn")
          .addEventListener("click", getAiSuggestion);

        function downloadFile(content, fileName, contentType) {
          const a = document.createElement("a");
          const file = new Blob([content], {
            type: contentType,
          });
          a.href = URL.createObjectURL(file);
          a.download = fileName;
          a.click();
          URL.revokeObjectURL(a.href);
        }

        document
          .getElementById("export-json-btn")
          .addEventListener("click", () => {
            const dataToExport = JSON.stringify(
              allSchedules.map(({ id, ...rest }) => rest),
              null,
              2
            );
            downloadFile(
              dataToExport,
              "jadwal_pelajaran.json",
              "application/json"
            );
          });

        document
          .getElementById("export-csv-btn")
          .addEventListener("click", () => {
            let csvContent = "Hari,JP,Kelas,Mapel,Guru\r\n";
            const sortedSchedules = [...allSchedules].sort(
              (a, b) => a.day - b.day || a.jp - b.jp
            );
            sortedSchedules.forEach((s) => {
              const row = [
                daysOfWeek[s.day],
                s.jp,
                `"${s.classes.join("; ")}"`,
                `"${s.mapel}"`,
                `"${s.guru || ""}"`,
              ];
              csvContent += row.join(",") + "\r\n";
            });
            downloadFile(
              csvContent,
              "jadwal_pelajaran.csv",
              "text/csv;charset=utf-8;"
            );
          });

        setInterval(updateRealtimeClockAndHighlight, 1000);

        const infoForm = document.getElementById("info-form");
        const infoIdInput = document.getElementById("info-id");
        const infoTitleInput = document.getElementById("info-title");
        const infoUrlInput = document.getElementById("info-url");
        const infoDescInput = document.getElementById("info-description");
        const infoListContainer = document.getElementById("info-list");
        const infoContentContainer = document.getElementById("info-content");
        const infoCollRef = collection(
          db,
          `artifacts/${appId}/public/data/infoLinks`
        );

        infoForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = infoIdInput.value;
          const infoData = {
            title: infoTitleInput.value,
            url: infoUrlInput.value,
            description: infoDescInput.value,
          };

          if (id) {
            await setDoc(
              doc(db, `artifacts/${appId}/public/data/infoLinks`, id),
              infoData
            );
            showToast("Informasi berhasil diperbarui!");
          } else {
            await addDoc(infoCollRef, infoData);
            showToast("Informasi berhasil ditambahkan!");
          }
          infoForm.reset();
          infoIdInput.value = "";
        });

        document
          .getElementById("clear-info-form-btn")
          .addEventListener("click", () => {
            infoForm.reset();
            infoIdInput.value = "";
          });

        onSnapshot(infoCollRef, (snapshot) => {
          const infoItems = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));
          infoListContainer.innerHTML = "";
          infoContentContainer.innerHTML = "";

          if (infoItems.length === 0) {
            infoContentContainer.innerHTML =
              '<p class="text-xs text-slate-400 text-center">Belum ada informasi.</p>';
          }

          infoItems.forEach((item) => {
            const adminItem = document.createElement("div");
            adminItem.className =
              "bg-white p-3 rounded-lg shadow-sm flex justify-between items-start";
            adminItem.innerHTML = `
                        <div>
                            <p class="font-semibold text-slate-800">${
                              item.title
                            }</p>
                            <a href="${
                              item.url
                            }" target="_blank" class="text-xs text-indigo-600 hover:underline">${
              item.url
            }</a>
                            <p class="text-xs text-slate-500 mt-1">${
                              item.description || ""
                            }</p>
                        </div>
                        <div class="flex space-x-2 flex-shrink-0 ml-4">
                            <button class="edit-btn p-2 text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg></button>
                            <button class="delete-btn p-2 text-red-600 bg-red-100 rounded-md hover:bg-red-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                    `;
            adminItem.querySelector(".edit-btn").onclick = () => {
              infoIdInput.value = item.id;
              infoTitleInput.value = item.title;
              infoUrlInput.value = item.url;
              infoDescInput.value = item.description;
              window.scrollTo({
                top: 0,
                behavior: "smooth",
              });
            };
            adminItem.querySelector(".delete-btn").onclick = async () => {
              if (confirm(`Yakin ingin menghapus informasi "${item.title}"?`)) {
                await deleteDoc(
                  doc(db, `artifacts/${appId}/public/data/infoLinks`, item.id)
                );
                showToast("Informasi dihapus!");
              }
            };
            infoListContainer.appendChild(adminItem);

            const publicItem = document.createElement("a");
            publicItem.href = item.url;
            publicItem.target = "_blank";
            publicItem.className =
              "block bg-slate-50 p-3 rounded-lg hover:bg-indigo-50 transition-colors";
            publicItem.innerHTML = `
                         <p class="text-sm font-semibold text-indigo-700">${
                           item.title
                         }</p>
                         <p class="text-xs text-slate-500 mt-1">${
                           item.description || ""
                         }</p>
                    `;
            infoContentContainer.appendChild(publicItem);
          });
        });
      }

      init();
    </script>
  </body>
</html>
